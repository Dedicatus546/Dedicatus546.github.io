<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">


  <link rel="apple-touch-icon" href="/other/favicon.svg">
  <link rel="icon" type="image/svg+xml" href="/other/favicon.svg">
  <link rel="mask-icon" href="/other/favicon.svg" color="#222">

  <link rel="manifest" href="/other/mainfest.json">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@fancyapps/ui@5.0.31/dist/fancybox/fancybox.css" integrity="sha256-gkQVf8UKZgQ0HyuxL/VnacadJ+D2Kox2TCEBuNQg5+w=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"prohibitorum.top","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"flat"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"algolia":{"appID":"T3MJ56EZKX","apiKey":"d231b9edc85683ea50e37ff0bdc95d43","indexName":"blog","hits":{"per_page":10}}}</script><script src="/js/config.js"></script>

    <meta name="description" content="前言之前写过手写 Promise 的实现，这次来写写它的一些工具函数和对象函数的实现">
<meta property="og:type" content="article">
<meta property="og:title" content="Promise上的一些工具函数的实现">
<meta property="og:url" content="https://prohibitorum.top/adaf14f3e5d5">
<meta property="og:site_name" content="恋の歌">
<meta property="og:description" content="前言之前写过手写 Promise 的实现，这次来写写它的一些工具函数和对象函数的实现">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2020/11/12/9j8hUrfHgoTJZlu.png">
<meta property="og:image" content="https://i.loli.net/2020/11/12/8gW7HmNujoDS31R.png">
<meta property="og:image" content="https://i.loli.net/2020/11/12/NDYGvb3yZam6UAf.png">
<meta property="og:image" content="https://i.loli.net/2020/11/12/NDYGvb3yZam6UAf.png">
<meta property="og:image" content="https://i.loli.net/2020/11/12/Szn9YAcfMspw64r.png">
<meta property="article:published_time" content="2020-11-11T15:45:45.000Z">
<meta property="article:modified_time" content="2023-02-13T18:28:45.000Z">
<meta property="article:author" content="Dedicatus545">
<meta property="article:tag" content="JavaScript">
<meta property="article:tag" content="Promise">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2020/11/12/9j8hUrfHgoTJZlu.png">


<link rel="canonical" href="https://prohibitorum.top/adaf14f3e5d5.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://prohibitorum.top/adaf14f3e5d5","path":"adaf14f3e5d5.html","title":"Promise上的一些工具函数的实现"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Promise上的一些工具函数的实现 | 恋の歌</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-TDBJV1DQ49"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-TDBJV1DQ49","only_pageview":false,"measure_protocol_api_secret":null}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">恋の歌</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">koi-no-uta</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container">
  <div class="algolia-stats"><hr></div>
  <div class="algolia-hits"></div>
  <div class="algolia-pagination"></div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%AD%A3%E6%96%87"><span class="nav-number">2.</span> <span class="nav-text">正文</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Promise-resolve"><span class="nav-number">2.1.</span> <span class="nav-text">Promise.resolve</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Promise-reject"><span class="nav-number">2.2.</span> <span class="nav-text">Promise.reject</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Promise-prototype-catch"><span class="nav-number">2.3.</span> <span class="nav-text">Promise.prototype.catch</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Promise-prototype-finally"><span class="nav-number">2.4.</span> <span class="nav-text">Promise.prototype.finally</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%83%85%E5%86%B5-1"><span class="nav-number">2.4.1.</span> <span class="nav-text">情况 1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%83%85%E5%86%B5-2"><span class="nav-number">2.4.2.</span> <span class="nav-text">情况 2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%83%85%E5%86%B5-3"><span class="nav-number">2.4.3.</span> <span class="nav-text">情况 3</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Promise-all"><span class="nav-number">2.5.</span> <span class="nav-text">Promise.all</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Promise-allSettled"><span class="nav-number">2.6.</span> <span class="nav-text">Promise.allSettled</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Promise-any"><span class="nav-number">2.7.</span> <span class="nav-text">Promise.any</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Promise-race"><span class="nav-number">2.8.</span> <span class="nav-text">Promise.race</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Dedicatus545"
      src="https://avatars.githubusercontent.com/u/48575405?v=4">
  <p class="site-author-name" itemprop="name">Dedicatus545</p>
  <div class="site-description" itemprop="description">Index-Librorum-Prohibitorum</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">192</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">156</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/Dedicatus546" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Dedicatus546" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:1607611087@qq.com" title="E-Mail → mailto:1607611087@qq.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans" class="cc-opacity" rel="noopener" target="_blank"><img src="https://fastly.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://prohibitorum.top/adaf14f3e5d5">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/48575405?v=4">
      <meta itemprop="name" content="Dedicatus545">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="恋の歌">
      <meta itemprop="description" content="Index-Librorum-Prohibitorum">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Promise上的一些工具函数的实现 | 恋の歌">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Promise上的一些工具函数的实现
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-11-11 15:45:45" itemprop="dateCreated datePublished" datetime="2020-11-11T15:45:45+00:00">2020-11-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-02-13 18:28:45" itemprop="dateModified" datetime="2023-02-13T18:28:45+00:00">2023-02-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BC%96%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">编程</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.5k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>9 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>之前写过手写 Promise 的实现，这次来写写它的一些工具函数和对象函数的实现</p>
<span id="more"></span>

<p>本文基于之前<code>Promise</code>以及相关<code>then</code>方法。</p>
<p>之前自定义的<code>Promise</code>函数名字为<code>MyPromise</code>，下文都以<code>MyPromise</code>来表示</p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><h2 id="Promise-resolve"><a href="#Promise-resolve" class="headerlink" title="Promise.resolve"></a><code>Promise.resolve</code></h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/resolve">Promise.resolve - MDN</a></p>
</blockquote>
<p>根据文档上的解析</p>
<blockquote>
<p><code>Promise.resolve(value)</code>方法返回一个以给定值解析后的<code>Promise</code>对象。如果这个值是一个<code>Promise</code>，那么将返回这个<code>Promise</code>；如果这个值是<code>thenable</code>（即带有<code>&quot;then&quot;</code> 方法），返回的<code>Promise</code>会“跟随”这个<code>thenable</code>的对象，采用它的最终状态；否则返回的<code>Promise</code>将以此值完成。此函数将类<code>Promise</code>对象的多层嵌套展平。</p>
</blockquote>
<p>可以看到<code>Promise.resolve</code>是以参数<code>value</code>的类型来决定如何处理返回的<code>Promise</code>，而不是一味的<code>resolve</code>掉这个<code>Promise</code></p>
<p>看到网上有如下的实现</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">MyPromise</span>.<span class="property">resolve</span> = <span class="keyword">function</span> (<span class="params">val</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">resolve</span>(val);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这样实现是百分百不对的，可以测试下面的代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="number">1</span>)).<span class="title function_">then</span>(</span><br><span class="line">  <span class="function">(<span class="params">val</span>) =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`val: <span class="subst">$&#123;val&#125;</span>`</span>),</span><br><span class="line">  <span class="function">(<span class="params">err</span>) =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`err: <span class="subst">$&#123;err&#125;</span>`</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>输出是执行第二个参数的回调，也就是输出<code>err: 1</code>，如下</p>
<p><img data-src="https://i.loli.net/2020/11/12/9j8hUrfHgoTJZlu.png"></p>
<p>所以<code>Promise.resolve</code>只是通过传入参数<code>value</code>来决定，所以实现如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">MyPromise</span>.<span class="property">resolve</span> = <span class="keyword">function</span> (<span class="params">val</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> returnPromise;</span><br><span class="line">  <span class="keyword">return</span> (returnPromise = <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// MyPromiseResolve是之前实现Promise实现的</span></span><br><span class="line">    <span class="title class_">MyPromiseResolve</span>(returnPromise, val, resolve, reject);</span><br><span class="line">  &#125;));</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Promise-reject"><a href="#Promise-reject" class="headerlink" title="Promise.reject"></a><code>Promise.reject</code></h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/reject">Promise.reject - MDN</a></p>
</blockquote>
<p><code>Promise.reject</code>就没有<code>Promise.resolve</code>复杂，它的逻辑就非常单纯，就是以传入的值拒绝返回的<code>Promise</code>对象即可，比如</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="number">1</span>)).<span class="title function_">then</span>(</span><br><span class="line">  <span class="function">(<span class="params">res</span>) =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`res: <span class="subst">$&#123;res&#125;</span>`</span>),</span><br><span class="line">  <span class="function">(<span class="params">err</span>) =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`err: <span class="subst">$&#123;err&#125;</span>`</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>上面这个<code>Promise</code>会以<code>Promise.resolve(1)</code>作为失败原因被拒绝</p>
<p><img data-src="https://i.loli.net/2020/11/12/8gW7HmNujoDS31R.png"></p>
<p>那么实现如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">MyPromise</span>.<span class="property">reject</span> = <span class="keyword">function</span> (<span class="params">val</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">reject</span>(val);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Promise-prototype-catch"><a href="#Promise-prototype-catch" class="headerlink" title="Promise.prototype.catch"></a><code>Promise.prototype.catch</code></h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/catch">Promise.prototype.catch - MDN</a></p>
</blockquote>
<p><code>catch</code>方法用于注册一个<code>Promise</code>被<code>reject</code>时的回调，所以可以使用<code>then</code>方法来实现<code>catch</code>（可以说<code>catch</code>是一个特殊的<code>then</code>）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">MyPromise</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">catch</span> = <span class="keyword">function</span> (<span class="params">onRejected</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">then</span>(<span class="literal">null</span>, onRejected);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>由于<code>then</code>会返回新的<code>Promise</code>，所以无需我们去创建一个新的<code>Promise</code>返回</p>
<h2 id="Promise-prototype-finally"><a href="#Promise-prototype-finally" class="headerlink" title="Promise.prototype.finally"></a><code>Promise.prototype.finally</code></h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/finally">Promise.prototype.finally - MDN</a></p>
</blockquote>
<p><code>finally</code>方法注册的回调不管在<code>resolved</code>状态或者<code>rejected</code>状态都会进行执行，所以根据<code>catch</code>很容易写出下面的实现代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">MyPromise</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">finally</span> = <span class="keyword">function</span> (<span class="params">onFinally</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">then</span>(onFinally, onFinally);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>但这么写其实是有问题的，在提案上（现在已经为<code>ecma</code>的标准了）也有解释为啥不适用<code>then(f, f)</code>这种方式</p>
<blockquote>
<p><code>finally</code>方法的提案地址：<a target="_blank" rel="noopener" href="https://github.com/tc39/proposal-Promise-finally">tc39 &#x2F; proposal-Promise-finally</a></p>
</blockquote>
<p>在<code>README.md</code>中有一段</p>
<blockquote>
<p>Why not <strong><code>.then(f, f)</code></strong>?</p>
</blockquote>
<p>为什么不使用<code>.then(f, f)</code></p>
<blockquote>
<p><code>Promise.finally(func)</code> is similar to <code>Promise.then(func, func)</code>, but is different in a few critical ways:</p>
</blockquote>
<p><code>Promise.finally(func)</code>和<code>Promise.then(func, func)</code>有点类似，但是在一些比较关键的地方有所不同。</p>
<blockquote>
<ul>
<li>When creating a function inline, you can pass it once, instead of being forced to either declare it twice, or create a variable for it</li>
<li>A <code>finally</code> callback will not receive any argument, since there’s no reliable means of determining if the Promise was fulfilled or rejected. This use case is for precisely when you do not care about the rejection reason, or the fulfillment value, and so there’s no need to provide it.</li>
<li>Unlike <code>Promise.resolve(2).then(() =&gt; &#123;&#125;, () =&gt; &#123;&#125;)</code> (which will be resolved with undefined), <code>Promise.resolve(2).finally(() =&gt; &#123;&#125;)</code> will be resolved with 2.</li>
<li>Similarly, unlike <code>Promise.reject(3).then(() =&gt; &#123;&#125;, () =&gt; &#123;&#125;)</code> (which will be resolved with undefined), <code>Promise.reject(3).finally(() =&gt; &#123;&#125;)</code> will be rejected with 3.</li>
</ul>
</blockquote>
<ul>
<li>当创建一个内联的函数，你只需要传递一次，而不需要强制传递两次声明的函数，或者不需要为这个函数创建一个变量来保存</li>
<li>一个<code>finally</code>回调不会接收任何参数，因为没有可靠的方法来判断<code>Promise</code>是否已经被解决或者被拒绝。当你不关心<code>Promise</code>被拒绝的原因或者被解决的值时使用<code>finally</code>会更加精确。所以不需要提供参数。</li>
<li>不像<code>Promise.resolve(2).then(() =&gt; &#123;&#125;, () =&gt; &#123;&#125;)</code>（这个<code>Promise</code>将会以<code>undefined</code>为值被解决），<code>Promise.resolve(2).finally(() =&gt; &#123;&#125;)</code>将会以<code>2</code>为值被解决</li>
<li>类似地，不像<code>Promise.reject(3).then(() =&gt; &#123;&#125;, () =&gt; &#123;&#125;)</code>（这个<code>Promise</code>将会以<code>undefined</code>为值被解决），<code>Promise.reject(3).finally(() =&gt; &#123;&#125;)</code>将会以<code>3</code>为值被拒绝</li>
</ul>
<blockquote>
<p>However, please note: a <code>throw</code> (or returning a rejected Promise) in the <code>finally</code> callback will reject the new Promise with that rejection reason.</p>
</blockquote>
<p>然而，请注意：在<code>finally</code>中抛出（或者返回一个被拒绝的<code>Promise</code>对象）会使得新的<code>Promise</code>对象以这个原因被拒绝。</p>
<p>我们可以测试下原生的 Promise 的情况</p>
<h3 id="情况-1"><a href="#情况-1" class="headerlink" title="情况 1"></a>情况 1</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Promise</span> = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="string">&quot;Promise.resolve&quot;</span>);</span><br><span class="line"><span class="comment">// 这里finally不返回</span></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">finally</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;finally&quot;</span>);</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这时根据规范，最后一个<code>then</code>的<code>onResolved</code>中的<code>res</code>应该是<code>&quot;Promise.resolve&quot;</code></p>
<p><img data-src="https://i.loli.net/2020/11/12/NDYGvb3yZam6UAf.png"></p>
<p>测试结果符合规范</p>
<h3 id="情况-2"><a href="#情况-2" class="headerlink" title="情况 2"></a>情况 2</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Promise</span> = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="string">&quot;Promise.resolve&quot;</span>);</span><br><span class="line"><span class="comment">// 这里finally返回一个resolved的Promise</span></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">finally</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;finally&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="string">&quot;finally Promise.resolve&quot;</span>);</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这时根据规范，最后一个<code>then</code>的<code>onResolved</code>中的<code>res</code>应该<strong>依然是</strong><code>&quot;Promise.resolve&quot;</code>，而<strong>不是</strong><code>&quot;finally Promise.resolve&quot;</code></p>
<p><img data-src="https://i.loli.net/2020/11/12/NDYGvb3yZam6UAf.png"></p>
<p>测试结果符合规范</p>
<h3 id="情况-3"><a href="#情况-3" class="headerlink" title="情况 3"></a>情况 3</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Promise</span> = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="string">&quot;Promise.resolve&quot;</span>);</span><br><span class="line"><span class="comment">// 这里finally返回一个rejected的Promise</span></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">finally</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;finally&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="string">&quot;finally Promise.reject&quot;</span>);</span><br><span class="line">&#125;).<span class="title function_">then</span>(</span><br><span class="line">  <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`res: <span class="subst">$&#123;res&#125;</span>`</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`err: <span class="subst">$&#123;err&#125;</span>`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>这时根据规范，<code>finally</code>中返回了一个<code>reject</code>的<code>Promise</code>，那么要以这个<code>Promise</code>的拒绝原因来拒绝新的<code>Promise</code>对象。</p>
<p>那么最后一个<code>then</code>应该走<code>catch</code>的回调，然后对应参数<code>err</code>为<code>&quot;finally Promise.reject&quot;</code>。</p>
<p><img data-src="https://i.loli.net/2020/11/12/Szn9YAcfMspw64r.png"></p>
<p>综上，我们讨论了<code>Promise.resolve</code>情况下<code>finally</code>的情况，还有<code>Promise.reject</code>情况下<code>finally</code>的情况。</p>
<p>但这两种情况对于<code>finally</code>的情况是一样的，所以这里不做测试，大家可以自行测试下。</p>
<p>所以，实现上必须和上面的行为保持一致</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">MyPromise</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">finally</span> = <span class="keyword">function</span> (<span class="params">onFinally</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">then</span>(</span><br><span class="line">    <span class="function">(<span class="params">res</span>) =&gt;</span></span><br><span class="line">      <span class="title class_">MyPromise</span>.<span class="title function_">resolve</span>(<span class="title function_">onFinally</span>()).<span class="title function_">then</span>(</span><br><span class="line">        <span class="comment">// finally回调正常，穿透原来的值</span></span><br><span class="line">        <span class="function">() =&gt;</span> res,</span><br><span class="line">        <span class="comment">// finally回调异常，抛出该异常</span></span><br><span class="line">        <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">throw</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">      ),</span><br><span class="line">    <span class="function">(<span class="params">err</span>) =&gt;</span></span><br><span class="line">      <span class="title class_">MyPromise</span>.<span class="title function_">resolve</span>(<span class="title function_">onFinally</span>()).<span class="title function_">then</span>(</span><br><span class="line">        <span class="comment">// finally回调正常，穿透原来的错误</span></span><br><span class="line">        <span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">throw</span> err;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// finally回调异常，抛出该异常</span></span><br><span class="line">        <span class="function">(<span class="params">_err</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">throw</span> _err;</span><br><span class="line">        &#125;</span><br><span class="line">      )</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>可以看到实现都是通过<code>MyPromise.resolve</code>来包装<code>onFinally</code>执行后的返回值，对于<code>resolved</code>的情况就返回原来<code>Promise</code>的<code>value</code>或者<code>err</code>，如果<code>rejected</code>那么抛出对应原因，也就符合了规范</p>
<p>可以发现，第二个参数的回调都是直接返回传入的值，所以可以省略</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">MyPromise</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">finally</span> = <span class="keyword">function</span> (<span class="params">onFinally</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">then</span>(</span><br><span class="line">    <span class="function">(<span class="params">res</span>) =&gt;</span> <span class="title class_">MyPromise</span>.<span class="title function_">resolve</span>(<span class="title function_">onFinally</span>()).<span class="title function_">then</span>(<span class="function">() =&gt;</span> res),</span><br><span class="line">    <span class="function">(<span class="params">err</span>) =&gt;</span></span><br><span class="line">      <span class="title class_">MyPromise</span>.<span class="title function_">resolve</span>(<span class="title function_">onFinally</span>()).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> err;</span><br><span class="line">      &#125;)</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Promise-all"><a href="#Promise-all" class="headerlink" title="Promise.all"></a><code>Promise.all</code></h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/all">Promise.all - MDN</a></p>
</blockquote>
<p>MDN 上对<code>Promise.all</code>的解释如下：</p>
<blockquote>
<p><code>Promise.all(iterable)</code>方法返回一个<code>Promise</code>实例，此实例在<code>iterable</code>参数内所有的<code>Promise</code>都“完成（resolved）”或参数中不包含<code>Promise</code>时回调完成（resolve）；如果参数中<code>Promise</code>有一个失败（rejected），此实例回调失败（reject），失败的原因是第一个失败<code>Promise</code>的结果。</p>
</blockquote>
<p>简单点讲，就是全部成功，返回的<code>Promise</code>才成功，只要一个失败，返回的<code>Promise</code>就失败。</p>
<p>那么对于全部这个状态，就需要有一个变量来计算当前是否已经全部完成。</p>
<p>以及对于数组中的非<code>Promise</code>对象，要包装成<code>Promise</code>。</p>
<p>实现如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">MyPromise</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">all</span> = <span class="keyword">function</span> <span class="title function_">PromiseAll</span>(<span class="params">promiseArr</span>) &#123;</span><br><span class="line">  <span class="comment">// 这里做了点小判断，支持直接传入一个Promise。</span></span><br><span class="line">  <span class="comment">// 然后浅拷贝一份，防止数组内的Promise动态的改变数组长度导致逻辑错误。</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="title class_">Array</span>.<span class="title function_">isArray</span>(promiseArr)) &#123;</span><br><span class="line">    promiseArr = [promiseArr];</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    promiseArr = promiseArr.<span class="title function_">slice</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> completeCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> result = [];</span><br><span class="line">    <span class="keyword">const</span> len = promiseArr.<span class="property">length</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">      <span class="comment">// 统一通过Promise.resolve包装，就可以忽略非Promise对象</span></span><br><span class="line">      <span class="title class_">MyPromise</span>.<span class="title function_">resolve</span>(promiseArr[i]).<span class="title function_">then</span>(</span><br><span class="line">        <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// 把结果放在数组中的对应地方</span></span><br><span class="line">          result[i] = res;</span><br><span class="line">          <span class="comment">// 计数判断是否完成</span></span><br><span class="line">          completeCount++;</span><br><span class="line">          <span class="keyword">if</span> (completeCount === len) &#123;</span><br><span class="line">            <span class="comment">// 已经全部解决了，用result来解决返回的Promise</span></span><br><span class="line">            <span class="title function_">resolve</span>(result);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="title function_">reject</span>(err);</span><br><span class="line">        &#125;</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Promise-allSettled"><a href="#Promise-allSettled" class="headerlink" title="Promise.allSettled"></a><code>Promise.allSettled</code></h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/allSettled">Promise.allSettled - MDN</a></p>
</blockquote>
<p>MDN 上解释如下</p>
<blockquote>
<p>该<code>Promise.allSettled()</code>方法返回一个在所有给定的<code>Promise</code>都已经<code>fulfilled</code>或<code>rejected</code>后的<code>Promise</code>，并带有一个对象数组，每个对象表示对应的<code>Promise</code>结果。</p>
</blockquote>
<blockquote>
<p>当您有多个彼此不依赖的异步任务成功完成时，或者您总是想知道每个<code>Promise</code>的结果时，通常使用它。</p>
</blockquote>
<p>简单点讲就是每个回调不管成功失败都放进结果，然后全部处理之后在解决返回的<code>Promise</code>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">MyPromise</span>.<span class="property">allSettled</span> = <span class="keyword">function</span> (<span class="params">promiseArr</span>) &#123;</span><br><span class="line">  <span class="comment">// 相同的处理</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="title class_">Array</span>.<span class="title function_">isArray</span>(promiseArr)) &#123;</span><br><span class="line">    promiseArr = [promiseArr];</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    promiseArr = promiseArr.<span class="title function_">slice</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> len = promiseArr.<span class="property">length</span>;</span><br><span class="line">    <span class="keyword">const</span> result = [];</span><br><span class="line">    <span class="keyword">let</span> completeCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; promiseArr.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="comment">// 这里分别在成功回调，失败回调在result对应位置写入成功结果或者失败原因</span></span><br><span class="line">      <span class="comment">// 在finally回调来计数，因为不管成功失败都要进行计数，然后一旦数组内的Promise全部执行完成，就解决返回的Promise</span></span><br><span class="line">      <span class="title class_">MyPromise</span>.<span class="title function_">resolve</span>(promiseArr[i])</span><br><span class="line">        .<span class="title function_">then</span>(</span><br><span class="line">          <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">            result[i] = &#123;</span><br><span class="line">              <span class="attr">status</span>: <span class="string">&quot;fulfilled&quot;</span>,</span><br><span class="line">              <span class="attr">value</span>: res,</span><br><span class="line">            &#125;;</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">            result[i] = &#123;</span><br><span class="line">              <span class="attr">status</span>: <span class="string">&quot;rejected&quot;</span>,</span><br><span class="line">              <span class="attr">value</span>: err,</span><br><span class="line">            &#125;;</span><br><span class="line">          &#125;</span><br><span class="line">        )</span><br><span class="line">        .<span class="title function_">finally</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          completeCount++;</span><br><span class="line">          <span class="keyword">if</span> (completeCount === len) &#123;</span><br><span class="line">            <span class="title function_">resolve</span>(result);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>上面的实现中，每个对象为<code>&#123; status: &quot;Promise的状态&quot;, value: &quot;对应的值&quot;&#125;</code></p>
<p>这是规范中所定义的，目前<code>Promise.allSettled</code>已经在 es2020 中添加了</p>
<p>规范地址：<a target="_blank" rel="noopener" href="https://github.com/tc39/proposal-Promise-allSettled">proposal-Promise-allSettled</a></p>
<h2 id="Promise-any"><a href="#Promise-any" class="headerlink" title="Promise.any"></a><code>Promise.any</code></h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/any">Promise.any - MDN</a></p>
</blockquote>
<p>MDN 上的解释如下</p>
<blockquote>
<p>接收一个<code>Promise</code>可迭代对象，只要其中的一个<code>Promise</code>成功，就返回那个已经成功的<code>Promise</code>。如果可迭代对象中没有一个<code>Promise</code>成功（即所有的<code>Promises</code>都失败&#x2F;拒绝），就返回一个失败的<code>Promise</code>和<code>AggregateError</code>类型的实例，它是<code>Error</code>的一个子类，用于把单一的错误集合在一起。本质上，这个方法和<code>Promise.all()</code>是相反的。</p>
</blockquote>
<p>解释上也很明显指出了，“和<code>Promise.all</code>相反”，也就是所有都失败才返回失败，一个成功就返回成功</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">MyPromise</span>.<span class="property">any</span> = <span class="keyword">function</span> (<span class="params">promiseArr</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="title class_">Array</span>.<span class="title function_">isArray</span>(promiseArr)) &#123;</span><br><span class="line">    promiseArr = [promiseArr];</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    promiseArr = promiseArr.<span class="title function_">slice</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> len = promiseArr.<span class="property">length</span>;</span><br><span class="line">    <span class="keyword">const</span> errResult = [];</span><br><span class="line">    <span class="keyword">let</span> completeCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; promiseArr.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="comment">// 这里和Promise.all相反，在reject回调中计数，在resolve回调中直接解决。</span></span><br><span class="line">      <span class="title class_">MyPromise</span>.<span class="title function_">resolve</span>(promiseArr[i]).<span class="title function_">then</span>(</span><br><span class="line">        <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="title function_">resolve</span>(res);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">          errResult[i] = err;</span><br><span class="line">          completeCount++;</span><br><span class="line">          <span class="comment">// 如果全部被拒绝</span></span><br><span class="line">          <span class="keyword">if</span> (completeCount === len) &#123;</span><br><span class="line">            <span class="comment">// 拒绝返回的Promise</span></span><br><span class="line">            <span class="title function_">reject</span>(&#123;</span><br><span class="line">              <span class="attr">status</span>: <span class="string">&quot;AggregateError: No Promise in Promise.any was resolved&quot;</span>,</span><br><span class="line">              errResult,</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>对于拒绝对象<code>&#123; status: &quot;AggregateError: No Promise in Promise.any was resolved&quot;, errArray&#125;</code></p>
<p>为提案中所定义的，所以这里我们直接构造即可，该 API 会在 es2021 中被加入</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/tc39/proposal-Promise-any">proposal-Promise-any</a></p>
</blockquote>
<h2 id="Promise-race"><a href="#Promise-race" class="headerlink" title="Promise.race"></a><code>Promise.race</code></h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/race">Promise.race - MDN</a></p>
</blockquote>
<p>MDN 上解释如下</p>
<blockquote>
<p><code>Promise.race(iterable)</code> 方法返回一个<code>Promise</code>，一旦迭代器中的某个<code>Promise</code>解决或拒绝，返回的<code>Promise</code>就会解决或拒绝。</p>
</blockquote>
<p>简单点讲就是竞速，谁快谁决定，这个是比较好实现的</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">MyPromise</span>.<span class="property">race</span> = <span class="keyword">function</span> <span class="title function_">PromiseRace</span>(<span class="params">promiseArr</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="title class_">Array</span>.<span class="title function_">isArray</span>(promiseArr)) &#123;</span><br><span class="line">    promiseArr = [promiseArr];</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    promiseArr = promiseArr.<span class="title function_">slice</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; promiseArr.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="comment">// 谁快谁解决，由于Promise在被resolve之后就不可变了，所以之后的resolve操作不会影响</span></span><br><span class="line">      <span class="title class_">MyPromise</span>.<span class="title function_">resolve</span>(promiseArr[i]).<span class="title function_">then</span>(</span><br><span class="line">        <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="title function_">resolve</span>(res);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="title function_">reject</span>(err);</span><br><span class="line">        &#125;</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Dedicatus545
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://prohibitorum.top/adaf14f3e5d5" title="Promise上的一些工具函数的实现">https://prohibitorum.top/adaf14f3e5d5</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/JavaScript/" rel="tag"># JavaScript</a>
              <a href="/tags/Promise/" rel="tag"># Promise</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/89a850efd727" rel="prev" title="Vue@next提案之script setup和ref sugar">
                  <i class="fa fa-angle-left"></i> Vue@next提案之script setup和ref sugar
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/8dfc6f70d3ec" rel="next" title="轮播图的简单实现position绝对定位版">
                  轮播图的简单实现position绝对定位版 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Dedicatus545</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">425k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">25:45</span>
  </span>
</div>

<div class="site_sign">
  <span class="post-meta-item">
    <span>
      如果我和狗一样有尾巴的话，一定会藏不住这份喜悦，而尾巴一直摇个不停吧。
    </span>
  </span>
</div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://fastly.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://fastly.jsdelivr.net/npm/@fancyapps/ui@5.0.31/dist/fancybox/fancybox.umd.js" integrity="sha256-a+H7FYzJv6oU2hfsfDGM2Ohw/cR9v+hPfxHCLdmCrE8=" crossorigin="anonymous"></script>
  <script src="https://fastly.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://fastly.jsdelivr.net/npm/algoliasearch@4.23.3/dist/algoliasearch-lite.umd.js" integrity="sha256-1QNshz86RqXe/qsCBldsUu13eAX6n/O98uubKQs87UI=" crossorigin="anonymous"></script>
<script src="https://fastly.jsdelivr.net/npm/instantsearch.js@4.67.0/dist/instantsearch.production.min.js" integrity="sha256-TW7D3X/i/W+RUgEeDppEnFT2ixv5lzplKH0c58D92dY=" crossorigin="anonymous"></script><script src="/js/third-party/search/algolia-search.js"></script>




  <script src="/js/third-party/fancybox.js"></script>



  




<link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/gitalk@1.8.0/dist/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"Dedicatus546","repo":"gitalk","client_id":"f7dc1ebbf18fc0fd3a5c","client_secret":"0893318788a1b62f883bdace8c12e6c42d76b402","admin_user":"Dedicatus546","distraction_free_mode":true,"proxy":"https://strong-caramel-969805.netlify.app/github_access_token","language":"zh-CN","js":{"url":"https://fastly.jsdelivr.net/npm/gitalk@1.8.0/dist/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"1605080745"}</script>
<script src="/js/third-party/comments/gitalk.js"></script>

<!-- hexo injector body_end start -->
<script src="https://cdn.jsdelivr.net/npm/swiper@11.1.9/swiper-bundle.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11.1.9/swiper-bundle.min.css">
<style>
    :root {
      --swiper-theme-color: var(--theme-color);
      --swiper-pagination-bottom: 0;
    }
    .swiper {
      padding-bottom: 32px;
      margin-bottom: 20px;
    }
    .swiper .swiper-slide .swiper-slide-img {
      display: block;
      width: 100%;
      object-fit: contain;
      background: var(--body-bg-color);
      margin: 0;
    }
  </style><!-- hexo injector body_end end --></body>
</html>
