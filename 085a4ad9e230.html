<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">


  <link rel="apple-touch-icon" href="/other/favicon.svg">
  <link rel="icon" type="image/svg+xml" href="/other/favicon.svg">
  <link rel="mask-icon" href="/other/favicon.svg" color="#222">

  <link rel="manifest" href="/other/mainfest.json">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@fancyapps/ui@5.0.31/dist/fancybox/fancybox.css" integrity="sha256-gkQVf8UKZgQ0HyuxL/VnacadJ+D2Kox2TCEBuNQg5+w=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"prohibitorum.top","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"flat"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"},"algolia":{"appID":"T3MJ56EZKX","apiKey":"d231b9edc85683ea50e37ff0bdc95d43","indexName":"blog","hits":{"per_page":10}}}</script><script src="/js/config.js"></script>

    <meta name="description" content="å‰è¨€å¼€ä¸ªå‘ï¼Œæœ€è¿‘çœ‹çš„Vuex@next(4.0)çš„æºç ï¼Œæºç ä¸å¤æ‚ï¼Œå¯ä»¥æ‹¿å‡ºæ¥å†™å†™ å½“ä½œä¸€ä¸ªç¬”è®°ï¼Œå¦‚æœå¸®åŠ©åˆ°ä½ ç†è§£äº†ï¼Œé‚£ä¹ˆæˆ‘ä¼šç›¸å½“å¼€å¿ƒğŸ˜˜">
<meta property="og:type" content="article">
<meta property="og:title" content="Vuex@nextæºç è§£æ - storeç¯‡">
<meta property="og:url" content="https://prohibitorum.top/085a4ad9e230">
<meta property="og:site_name" content="æ‹ã®æ­Œ">
<meta property="og:description" content="å‰è¨€å¼€ä¸ªå‘ï¼Œæœ€è¿‘çœ‹çš„Vuex@next(4.0)çš„æºç ï¼Œæºç ä¸å¤æ‚ï¼Œå¯ä»¥æ‹¿å‡ºæ¥å†™å†™ å½“ä½œä¸€ä¸ªç¬”è®°ï¼Œå¦‚æœå¸®åŠ©åˆ°ä½ ç†è§£äº†ï¼Œé‚£ä¹ˆæˆ‘ä¼šç›¸å½“å¼€å¿ƒğŸ˜˜">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2020/10/28/MaNc2XsY6ZHKt1U.png">
<meta property="og:image" content="https://i.loli.net/2020/10/21/uGT6hJ537UrbCOv.png">
<meta property="og:image" content="https://i.loli.net/2020/10/21/FmfZ3XvpaWdJg6z.gif">
<meta property="og:image" content="https://i.loli.net/2020/10/21/pEx2Qqvc8DjW7sF.png">
<meta property="og:image" content="https://i.loli.net/2020/10/21/qrJdgFo7iuScPja.png">
<meta property="og:image" content="https://i.loli.net/2020/10/22/5wb13tfjiXrLPYR.png">
<meta property="og:image" content="https://i.loli.net/2020/10/22/rANBkSZ6CJ28il4.png">
<meta property="og:image" content="https://i.loli.net/2020/10/22/f6JDmGWx1L3lH2Q.png">
<meta property="og:image" content="https://i.loli.net/2020/10/22/zsdokDE983AK7C1.png">
<meta property="og:image" content="https://i.loli.net/2020/10/22/6CpHULjgrhfnS1G.png">
<meta property="og:image" content="https://i.loli.net/2020/10/23/IZk3ovmrM7sBEQ8.png">
<meta property="article:published_time" content="2020-10-21T16:02:10.000Z">
<meta property="article:modified_time" content="2023-02-13T18:28:43.000Z">
<meta property="article:author" content="Dedicatus545">
<meta property="article:tag" content="JavaScript">
<meta property="article:tag" content="Vue">
<meta property="article:tag" content="Vuex">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2020/10/28/MaNc2XsY6ZHKt1U.png">


<link rel="canonical" href="https://prohibitorum.top/085a4ad9e230.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://prohibitorum.top/085a4ad9e230","path":"085a4ad9e230.html","title":"Vuex@nextæºç è§£æ - storeç¯‡"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Vuex@nextæºç è§£æ - storeç¯‡ | æ‹ã®æ­Œ</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-TDBJV1DQ49"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-TDBJV1DQ49","only_pageview":false,"measure_protocol_api_secret":null}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">æ‹ã®æ­Œ</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">koi-no-uta</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="æœç´¢" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container">
  <div class="algolia-stats"><hr></div>
  <div class="algolia-hits"></div>
  <div class="algolia-pagination"></div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#store-js"><span class="nav-number">2.</span> <span class="nav-text">store.js</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#install"><span class="nav-number">2.1.</span> <span class="nav-text">install</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#state%E7%9A%84get%EF%BC%8Cset%E5%87%BD%E6%95%B0"><span class="nav-number">2.2.</span> <span class="nav-text">stateçš„getï¼Œsetå‡½æ•°</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#constructor-NaN"><span class="nav-number">2.3.</span> <span class="nav-text">constructor</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#commit"><span class="nav-number">2.4.</span> <span class="nav-text">commit</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dispatch"><span class="nav-number">2.5.</span> <span class="nav-text">dispatch</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#subscribe"><span class="nav-number">2.6.</span> <span class="nav-text">subscribe</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#subscribeAction"><span class="nav-number">2.7.</span> <span class="nav-text">subscribeAction</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#watch"><span class="nav-number">2.8.</span> <span class="nav-text">watch</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#replaceState"><span class="nav-number">2.9.</span> <span class="nav-text">replaceState</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#registerModule"><span class="nav-number">2.10.</span> <span class="nav-text">registerModule</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#unregisterModule"><span class="nav-number">2.11.</span> <span class="nav-text">unregisterModule</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#hasModule"><span class="nav-number">2.12.</span> <span class="nav-text">hasModule</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%86%85%E9%83%A8%E5%87%BD%E6%95%B0"><span class="nav-number">3.</span> <span class="nav-text">å†…éƒ¨å‡½æ•°</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#installModule"><span class="nav-number">3.1.</span> <span class="nav-text">installModule</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#resetStoreState"><span class="nav-number">3.2.</span> <span class="nav-text">resetStoreState</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#resetStore"><span class="nav-number">3.3.</span> <span class="nav-text">resetStore</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#makeLocalContext"><span class="nav-number">3.4.</span> <span class="nav-text">makeLocalContext</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#makeLocalGetters"><span class="nav-number">3.5.</span> <span class="nav-text">makeLocalGetters</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#registerGetter"><span class="nav-number">3.6.</span> <span class="nav-text">registerGetter</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#registerMutation"><span class="nav-number">3.7.</span> <span class="nav-text">registerMutation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#registerAction"><span class="nav-number">3.8.</span> <span class="nav-text">registerAction</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#getNestedState"><span class="nav-number">3.9.</span> <span class="nav-text">getNestedState</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%90%8E%E8%AE%B0"><span class="nav-number">4.</span> <span class="nav-text">åè®°</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Dedicatus545"
      src="https://avatars.githubusercontent.com/u/48575405?v=4">
  <p class="site-author-name" itemprop="name">Dedicatus545</p>
  <div class="site-description" itemprop="description">Index-Librorum-Prohibitorum</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">192</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">156</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/Dedicatus546" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;Dedicatus546" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:1607611087@qq.com" title="E-Mail â†’ mailto:1607611087@qq.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans" class="cc-opacity" rel="noopener" target="_blank"><img src="https://fastly.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://prohibitorum.top/085a4ad9e230">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/48575405?v=4">
      <meta itemprop="name" content="Dedicatus545">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ‹ã®æ­Œ">
      <meta itemprop="description" content="Index-Librorum-Prohibitorum">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Vuex@nextæºç è§£æ - storeç¯‡ | æ‹ã®æ­Œ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Vuex@nextæºç è§£æ - storeç¯‡
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2020-10-21 16:02:10" itemprop="dateCreated datePublished" datetime="2020-10-21T16:02:10+00:00">2020-10-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2023-02-13 18:28:43" itemprop="dateModified" datetime="2023-02-13T18:28:43+00:00">2023-02-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">ç¬”è®°</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>8.5k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>31 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å¼€ä¸ªå‘ï¼Œæœ€è¿‘çœ‹çš„<code>Vuex@next(4.0)</code>çš„æºç ï¼Œæºç ä¸å¤æ‚ï¼Œå¯ä»¥æ‹¿å‡ºæ¥å†™å†™</p>
<p>å½“ä½œä¸€ä¸ªç¬”è®°ï¼Œå¦‚æœå¸®åŠ©åˆ°ä½ ç†è§£äº†ï¼Œé‚£ä¹ˆæˆ‘ä¼šç›¸å½“å¼€å¿ƒğŸ˜˜</p>
<span id="more"></span>

<p>æºç ä¸æ˜¯å¾ˆå¤æ‚ï¼Œæ–‡ä»¶ä¹Ÿä¸å¤šï¼Œä½†æ˜¯æˆ‘æ„Ÿè§‰å†™çš„å°å·§ï¼Œå¾ˆæ£’</p>
<p>åº”è¯¥ä¼šåˆ†æˆå‡ ä¸ªå¸–å­æ¥å†™ï¼Œä¸»è¦æŒ‰ç…§æ¯ä¸ªæ–‡ä»¶æ¥å†™ï¼Œå¦‚æœæœ‰æ›´å¥½åœ°ç¼–å†™æ–¹å¼ï¼Œå¯ä»¥ç•™è¨€ç»™æˆ‘ï¼Œå› ä¸ºå¯¹æˆ‘æ¥è¯´ï¼Œåˆ†æ–‡ä»¶å†™èµ·æ¥æœ‰æ¡ä¾‹ä»¥åŠå¯ä»¥å¾ªåºæ¸è¿›</p>
<p><code>Vuex</code>ï¼Œæ˜¯<code>Vue</code>å®˜æ–¹çš„ä¸€ä¸ªå…¨å±€çŠ¶æ€ç®¡ç†ï¼Œå¯ä»¥ç†è§£æˆä¸€ä¸ªå…¨å±€çš„<code>data</code>ï¼ˆç±»ä¼¼ç»„ä»¶é‡Œé¢çš„<code>data</code>å±æ€§ï¼‰</p>
<p><code>Vuex</code>ä¹Ÿæœ‰æš´éœ²ä¸€äº›è‡ªå·±çš„æ–¹æ³•ï¼Œæ¯”å¦‚ç±»ä¼¼ç»„ä»¶çš„è®¡ç®—å±æ€§ï¼ˆ<code>getter</code>ï¼‰ï¼ŒåŒæ­¥çš„ä¿®æ”¹æ•°æ®æ“ä½œï¼ˆ<code>mutation</code>ï¼‰ï¼Œæ”¯æŒå¼‚æ­¥æ–¹å¼ä¿®æ”¹æ•°æ®çš„æ“ä½œï¼ˆ<code>action</code>ï¼‰</p>
<p>ä¸ªäººè§‰å¾—ï¼Œå¦‚æœæƒ³è¦ç†è§£æºç ï¼Œæœ€å¥½æ˜¯å…ˆè¯»å®ƒçš„<code>API</code>ï¼ŒçŸ¥é“äº†å®ƒçš„<code>API</code>æ˜¯å¹²ä»€ä¹ˆçš„ï¼Œçœ‹èµ·æºç æ¥æ‰èƒ½æ›´å¥½åœ°ç†è§£</p>
<p>åº”è¯¥ä¼šåˆ†æˆå‡ ä¸ªéƒ¨åˆ†æ¥å†™</p>
<ul>
<li><code>store.js</code> å…¥å£æ–‡ä»¶ï¼Œåˆ›å»ºä¸€ä¸ª<code>store</code>çš„æ ¸å¿ƒæ–‡ä»¶</li>
<li><code>module-colleton.js</code><br>æ¨¡å—åˆ—è¡¨å¯¹è±¡ï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥æ³¨å†Œ(<code>register</code>)ï¼ˆå¸è½½(<code>unregister</code>)ï¼‰ä¸€ä¸ªæ¨¡å—ï¼ŒåµŒå¥—æ¨¡å—</li>
<li><code>module.js</code> æ¨¡å—å¯¹è±¡ï¼Œæ¯ä¸ªæ¨¡å—çš„å¯¹è±¡ç±»</li>
<li><code>helper.js</code> å·¥å…·å‡½æ•°ï¼Œæ¯”å¦‚<code>mapGetters</code>ï¼Œ<code>mapMutations</code>ç­‰ç­‰</li>
</ul>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/vuejs/vuex/tree/4.0">Vuex@next(4.0)ä»“åº“</a><br><a target="_blank" rel="noopener" href="https://github.com/vuejs/vuex/tree/v4-docs/docs">Vuex@next(4.0)æ–‡æ¡£ä»“åº“</a></p>
</blockquote>
<p>PSï¼šå¦‚æœç›´æ¥æœç´¢è®°å¾—åˆ‡æ¢åˆ†æ”¯ï¼ï¼ï¼å¦‚ä¸‹å›¾</p>
<p><img data-src="https://i.loli.net/2020/10/28/MaNc2XsY6ZHKt1U.png"></p>
<p><code>vuex.vuejs.org</code>çš„æ–‡æ¡£è¿˜æ˜¯<code>Vuex3</code>çš„ï¼Œä¸è¿‡<code>Vuex4</code>æš´éœ²çš„APIå’Œ<code>Vuex3</code>çš„åŸºæœ¬ä¸€æ ·</p>
<p>æ‰€ä»¥å¦‚æœæƒ³äº†è§£<code>API</code>çš„ä½œç”¨çœ‹<code>Vuex3</code>çš„æ–‡æ¡£é—®é¢˜ä¸å¤§</p>
<p>å¦‚æœæƒ³çœ‹ç”¨ä¾‹çš„ï¼Œå°±å–ä¸Šé¢çš„æ–‡æ¡£ä»“åº“ä¸Šæ‰¾å¯¹åº”<code>API</code>çš„<code>MD</code>æ–‡ä»¶å³å¯</p>
<p>ä¹Ÿå¯ä»¥åŠç›´æ¥ <a target="_blank" rel="noopener" href="https://github.com/vuejs/vuex/blob/v4-docs/docs/api/index.md">ç‚¹æˆ‘</a> å°±å¯ä»¥çœ‹åˆ°å‡ ä¹å…¨éƒ¨çš„<code>API</code>äº†</p>
<p><code>Vuex</code>çš„é¡¹ç›®ç»“æ„ä¸å¤æ‚ï¼ˆPSï¼šæŠ¥çº¢çš„åŸå› æ˜¯æˆ‘æ²¡æœ‰å®‰è£…ä¾èµ–ï¼‰</p>
<p><img data-src="https://i.loli.net/2020/10/21/uGT6hJ537UrbCOv.png"></p>
<p>Soï¼Œæˆ‘è¿˜æ˜¯æœ‰ä¿¡å¿ƒè®²å¥½çš„~ okï¼Œé‚£ä¹ˆæˆ‘ä»¬å¼€å§‹å§~~</p>
<h1 id="store-js"><a href="#store-js" class="headerlink" title="store.js"></a><code>store.js</code></h1><p>æœ¬ç¯‡ä¸»è¦è®²å»ºç«‹ä¸€ä¸ª<code>store</code>çš„æ•´ä½“æµç¨‹ã€‚</p>
<p>ç”±äºåœ¨<code>Vue3</code>ä¸­å¼€å§‹æ¨è¡Œ<code>setup</code>å‡½æ•°æ¥è¿›è¡Œé€»è¾‘çš„ç¼–å†™ï¼Œæœ‰ä¸€ç‚¹<code>ReactHook</code>çš„å‘³é“ï¼Œæ¯”å¦‚</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;ageIncrementHandler&quot;</span>&gt;</span>å¢åŠ 1å²<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>åå­—: &#123;&#123; person.name &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>å²æ•°: &#123;&#123; person.age &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> &#123;reactive&#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">name</span>: <span class="string">&quot;Test&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> person = <span class="title function_">reactive</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">name</span>: <span class="string">&quot;lwf&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">age</span>: <span class="number">1</span></span></span><br><span class="line"><span class="language-javascript">    &#125;);</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> <span class="title function_">ageIncrementHandler</span> = (<span class="params"></span>) =&gt; &#123;</span></span><br><span class="line"><span class="language-javascript">      person.<span class="property">age</span>++;</span></span><br><span class="line"><span class="language-javascript">    &#125;;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">      person,</span></span><br><span class="line"><span class="language-javascript">      ageIncrementHandler</span></span><br><span class="line"><span class="language-javascript">    &#125;;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œæ•ˆæœå¦‚ä¸‹</p>
<p><img data-src="https://i.loli.net/2020/10/21/FmfZ3XvpaWdJg6z.gif"></p>
<p>åœ¨<code>Vuex3</code>ä¸­ï¼Œä¹Ÿæœ‰ä¸€ç‚¹è¿™ç§å‘³é“ï¼Œæˆ‘è§‰å¾—ä¸»è¦ä½“ç°åœ¨åˆ›å»º<code>store</code>ä¸Š</p>
<p><code>Vuex3</code>åˆ›å»º<code>store</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = <span class="keyword">new</span> <span class="title class_">Vuex</span>.<span class="title class_">Store</span>(&#123;</span><br><span class="line">  <span class="comment">// ...config</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>åˆ°äº†<code>Vuex4</code>ï¼Œåˆ›å»º<code>store</code>æ”¹ä¸º<strong>å‡½æ•°å¼åˆ›å»º</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// createStoreä¸ºVuexæš´éœ²çš„ä¸€ä¸ªAPI</span></span><br><span class="line"><span class="keyword">const</span> store = <span class="title function_">createStore</span>(&#123;</span><br><span class="line">  <span class="comment">// ...config</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>è¿™å…¶ä¸­éš¾é“æœ‰ä»€ä¹ˆé­”æ³•ï¼Ÿï¼Ÿï¼Ÿ</p>
<p>å…¶å®å¹¶æ²¡æœ‰ï¼Œåœ¨<code>store.js</code>ä¸­å¯ä»¥çœ‹åˆ°<code>createStore</code>çš„æºç </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createStore</span> (<span class="params">options</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Store</span>(options)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ— éæ˜¯åŒ…äº†ä¸€å±‚å‡½æ•°å¯¼å‡ºè€Œå·²</p>
<p><code>Vuex4</code>åœ¨è®¾è®¡æ—¶å…¼å®¹äº†<code>Vuex3</code>ï¼Œåœ¨<code>4.0</code>çš„ä»“åº“çš„<code>README.md</code>ä¸­çš„èµ·å§‹éƒ¨åˆ†å¯ä»¥çœ‹åˆ°å¦‚ä¸‹æè¿°</p>
<blockquote>
<p>This is the Vue 3 compatible version of Vuex. The focus is<br>compatibility, and it provides the exact same API as Vuex 3, so users<br>can reuse their existing Vuex code with Vue 3.</p>
</blockquote>
<p>å¤§æ„å°±æ˜¯<code>Vuex4</code>å…¼å®¹äº†<code>Vuex3</code>ï¼Œæš´éœ²äº†å’Œ<code>Vuex3</code>ç›¸åŒ<code>API</code>ï¼Œä½¿å¾—åœ¨æ—§çš„<code>Vuex</code>ä»£ç å¯ä»¥ä½¿ç”¨åœ¨<code>Vue3</code>ä¸Šã€‚</p>
<p>çœŸæ­£çš„æ ¸å¿ƒä»£ç ä¸ºä¸‹é¢çš„<code>Store</code>ç±»</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Store</span> &#123;</span><br><span class="line">  <span class="comment">// æ„é€ å™¨</span></span><br><span class="line">  <span class="title function_">constructor</span> (<span class="params">options = &#123;&#125;</span>) &#123;&#125;</span><br><span class="line">  <span class="comment">// æš´éœ²ç»™Vue3çš„å‡½æ•°</span></span><br><span class="line">  <span class="title function_">install</span> (app, injectKey) &#123;&#125;</span><br><span class="line">  <span class="comment">// æš´éœ²çš„stateï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„â€˜çŠ¶æ€â€™</span></span><br><span class="line">  get <span class="title function_">state</span> () &#123;&#125;</span><br><span class="line">  set <span class="title function_">state</span> (v) &#123;&#125;</span><br><span class="line">  <span class="comment">// ä¸¤ä¸ªæœ€å¸¸ç”¨çš„APIï¼Œcommitæäº¤mutationï¼Œdispatchåˆ†å‘ä¸€ä¸ªaction</span></span><br><span class="line">  <span class="title function_">commit</span> (_type, _payload, _options) &#123;&#125;</span><br><span class="line">  <span class="title function_">dispatch</span> (_type, _payload) &#123;&#125;</span><br><span class="line">  <span class="comment">// å¯¹commitæ“ä½œå’Œdispatchæ“ä½œæ³¨å†Œä¸€ä¸ªè®¢é˜…çš„å‡½æ•°</span></span><br><span class="line">  <span class="title function_">subscribe</span> (fn, options) &#123;&#125;</span><br><span class="line">  <span class="title function_">subscribeAction</span> (fn, options) &#123;&#125;</span><br><span class="line">  <span class="comment">// é€šè¿‡getterå‡½æ•°è¿”å›çŠ¶æ€ï¼Œå¯ä»¥è§‚å¯ŸçŠ¶æ€çš„å˜åŒ–å¹¶æ‰§è¡Œcbå‡½æ•°</span></span><br><span class="line">  <span class="title function_">watch</span> (getter, cb, options) &#123;&#125;</span><br><span class="line">  <span class="comment">// æ›¿æ¢state</span></span><br><span class="line">  <span class="title function_">replaceState</span> (state) &#123;&#125;</span><br><span class="line">  <span class="comment">// æ³¨å†Œå’Œå¸è½½ä¸€ä¸ªæ¨¡å—</span></span><br><span class="line">  <span class="title function_">registerModule</span> (path, rawModule, options = &#123;&#125;) &#123;&#125;</span><br><span class="line">  <span class="title function_">unregisterModule</span> (path) &#123;&#125;</span><br><span class="line">  <span class="comment">// åˆ¤æ–­æ¨¡å—åæ˜¯å¦è¢«æ³¨å†Œ</span></span><br><span class="line">  <span class="title function_">hasModule</span> (path) &#123;&#125;</span><br><span class="line">  <span class="comment">// çƒ­é‡è½½ç›¸å…³</span></span><br><span class="line">  <span class="title function_">hotUpdate</span> (newOptions) &#123;&#125;</span><br><span class="line">  <span class="comment">// å†…éƒ¨å‡½æ•°ï¼Œç”¨äºæ”¹å˜_state.dataçš„å€¼è€Œä¸å‡ºç°æŠ¥é”™</span></span><br><span class="line">  <span class="title function_">_withCommit</span> (fn) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçœç•¥äº†å®ç°çš„ä»£ç ï¼Œä¸ºäº†ä»å®è§‚ä¸Šå»è®¤è¯†è¿™ä¸ªç±»</p>
<!--- `constructor` `es6`ç±»çš„å†™æ³•ï¼Œç±»ä¼¼`Java`çš„ç±»ï¼Œ`new`çš„æ—¶å€™ä¼šæ‰§è¡Œè¿™æ®µä»£ç -->
<!--- `install` æš´éœ²çš„installå‡½æ•°ï¼Œ`VueApp`é€šè¿‡`use`æ¥å®‰è£…è¿™ä¸ªæ’ä»¶-->
<!--  ```javascript-->
<!--  import {createApp} from "vue";-->
<!--  import store from "./store";-->
<!--  import App from "./App.vue";-->
<!--  createApp(App)-->
<!--    // å®‰è£…-->
<!--    .use(store)-->
<!--    .mount("#app");-->
<!--  ```-->
<!--- `get state` `state`å˜é‡çš„`get`å‡½æ•°-->
<!--- `set state` `state`å˜é‡çš„`set`å‡½æ•°-->
<!--- `commit` æ‰§è¡Œä¸€ä¸ª`mutation`-->
<!--- `dispatch` æäº¤ä¸€ä¸ª`action`-->
<!--- `subscribe` æ³¨å†Œä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°åœ¨æ¯ä¸ª`mutation`å®Œæˆä¹‹åè°ƒç”¨-->
<!--- `subscribeAction` æ³¨å†Œä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å¯ä»¥é€šè¿‡é…ç½®æŒ‡å®šåœ¨`action`ä¹‹å‰ï¼Œä¹‹åï¼Œå‡ºé”™æƒ…å†µä¸‹è°ƒç”¨-->
<!--- `watch` ä¾¦å¬`state`çš„å˜åŒ–ï¼Œæ‰§è¡Œå›è°ƒ-->
<!--- `replaceState` æ›¿æ¢æ•´ä¸ªçŠ¶æ€æ ‘ï¼Œä¸€èˆ¬åœ¨è°ƒè¯•çŠ¶æ€ä¸‹ä½¿ç”¨-->
<!--- `registerModule`å’Œ`unregisterModule` æ³¨å†Œå’Œå¸è½½ä¸€ä¸ªæ¨¡å—-->
<!--- `hasModule` æ£€æŸ¥æ¨¡å—åæ˜¯å¦è¢«æ³¨å†Œ-->
<!--- `hotUpdate` çƒ­æ›¿æ¢æ¨¡å—-->
<!--- `_withCommit` å†…éƒ¨å‡½æ•°ï¼Œç”¨äºä¿®æ”¹å†…éƒ¨`_state`-->

<h2 id="install"><a href="#install" class="headerlink" title="install"></a><code>install</code></h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Store</span> &#123;</span><br><span class="line">  <span class="title function_">install</span> (app, injectKey) &#123;</span><br><span class="line">    app.<span class="title function_">provide</span>(injectKey || storeKey, <span class="variable language_">this</span>)</span><br><span class="line">    app.<span class="property">config</span>.<span class="property">globalProperties</span>.<span class="property">$store</span> = <span class="variable language_">this</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®‰è£…å‡½æ•°å¾ˆç®€å•</p>
<p>é€šè¿‡<code>Vue3</code>çš„<code>provide</code>APIæ³¨å…¥äº†è‡ªèº«ï¼Œå¹¶ä¸”æŠŠè‡ªèº«æŒ‚è½½åˆ°<code>app.config.globalProperties</code>çš„<code>$store</code>ä¸Š</p>
<p><code>provide</code>æ³¨å…¥ï¼Œè¿™æ ·åœ¨<code>setup</code>å‡½æ•°ä¸­å°±å¯ä»¥ä½¿ç”¨<code>useStore</code>ï¼ˆ<code>Vuex4</code>æš´éœ²çš„<code>API</code>ï¼‰æ¥è·å–<code>store</code>å¯¹è±¡ï¼Œæ³¨æ„ï¼šåœ¨<code>setup</code>å‡½æ•°ä¸­æ²¡æœ‰<code>this</code>ï¼ï¼ï¼</p>
<p><code>globalProperties</code>æŒ‚è½½ï¼Œä½¿å¾—<code>Vue2</code>çš„æ–¹å¼ä¸­å¯ä»¥é€šè¿‡<code>this</code>æ¥è·å–<code>store</code>ï¼Œè¿™ç§æ–¹æ³•å–ä»£äº†<code>Vue2</code>çš„<code>Vue.prototype.propertyName   = value</code>ï¼Œæ¯”å¦‚ä¹‹å‰æƒ³æŒ‚è½½ç»è¿‡<code>axios</code>å°è£…çš„<code>API</code>å±‚ï¼Œä¸€èˆ¬å¦‚ä¸‹å†™</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é€šè¿‡axioså°è£…çš„APIå±‚</span></span><br><span class="line"><span class="keyword">import</span> http <span class="keyword">from</span> <span class="string">&#x27;./http&#x27;</span>;</span><br><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$http</span> = http;</span><br></pre></td></tr></table></figure>

<p>ç„¶ååœ¨ç»„ä»¶ä¸­</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="title function_">mounted</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// è·å–httpå¯¹è±¡</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">$http</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è€Œåœ¨<code>Vue3</code>ä¸­ï¼Œåªéœ€è¦æŒ‚è½½åˆ°<code>app.config.globalProperties</code>å³å¯æœ‰ç›¸åŒçš„æ•ˆæœ</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> http <span class="keyword">from</span> <span class="string">&#x27;./http&#x27;</span>;</span><br><span class="line"><span class="comment">// å¯¼å…¥å…¶ä»–ä¾èµ–</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">createApp</span>(<span class="title class_">App</span>)</span><br><span class="line">app.<span class="property">config</span>.<span class="property">globalProperties</span>.<span class="property">$http</span> = http;</span><br><span class="line">app.<span class="title function_">mount</span>(<span class="string">&quot;#app&quot;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="stateçš„getï¼Œsetå‡½æ•°"><a href="#stateçš„getï¼Œsetå‡½æ•°" class="headerlink" title="stateçš„getï¼Œsetå‡½æ•°"></a><code>state</code>çš„<code>get</code>ï¼Œ<code>set</code>å‡½æ•°</h2><p>æˆ‘ä»¬çŸ¥é“ï¼ŒVuexä¸å…è®¸æˆ‘ä»¬ç›´æ¥æ›´æ”¹<code>state</code>çŠ¶æ€ï¼Œå¿…é¡»é€šè¿‡<code>commit</code>ä¸€ä¸ª<code>mutation</code></p>
<p>æˆ–è€…<code>dispatch</code>ä¸€ä¸ª<code>action</code>æ¥æ›´æ”¹çŠ¶æ€</p>
<p>ä»å®ƒæºç å¯ä»¥çœ‹å‡ºï¼Œ<code>state</code>å±æ€§ä¸æ˜¯çœŸæ­£å­˜æ”¾çŠ¶æ€çš„åœ°æ–¹ï¼Œåªæ˜¯å¯¹å¤–æš´éœ²çš„ä¸€ä¸ªæ¥å£ï¼Œé€šè¿‡å®šä¹‰<code>get</code>å’Œ<code>set</code>æ¥é™åˆ¶ç”¨æˆ·çš„è¡Œä¸º</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Store</span> &#123;</span><br><span class="line">  get <span class="title function_">state</span> () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_state</span>.<span class="property">data</span></span><br><span class="line">  &#125;</span><br><span class="line">  set <span class="title function_">state</span> (v) &#123;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="title function_">assert</span>(<span class="literal">false</span>, <span class="string">`use store.replaceState() to explicit replace store state.`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°<code>get</code>è¿”å›äº†çœŸæ­£çš„çŠ¶æ€çš„ä¸€ä¸ªå±æ€§ï¼Œä½äº<code>_state.data</code></p>
<p>è€Œ<code>set</code>åˆ™ç›´æ¥æŠ¥é”™ï¼ˆå¼€å‘æ¨¡å¼<code>__DEV__</code>ä¸‹ï¼‰ï¼Œæé†’ç”¨æˆ·ä¸è¦ç›´æ¥ä¿®æ”¹çŠ¶æ€ï¼Œè€Œæ˜¯è¦ä½¿ç”¨<code>replaceState</code>è¿™ä¸ªå‡½æ•°æ¥ä¿®æ”¹çŠ¶æ€ã€‚</p>
<p>æ¯”å¦‚æˆ‘ä»¬åˆ›å»ºäº†ä¸‹é¢è¿™æ ·çš„<code>store</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = <span class="title function_">createStore</span>(&#123;</span><br><span class="line">  <span class="attr">state</span>: &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;lwf&quot;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">22</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥æ‰“å°ä¸‹<code>store</code>ï¼Œç¡®å®å‡ºç°äº†<code>_state.data</code>ï¼Œå¹¶ä¸”æ˜¯ä¸€ä¸ª<code>Proxy</code>å¯¹è±¡ï¼ˆå…¶å®è¿™æ˜¯ä¸€ä¸ªå“åº”å¼çš„å¯¹è±¡ï¼Œåé¢ä¼šå†™åˆ°ï¼‰</p>
<p><img data-src="https://i.loli.net/2020/10/21/pEx2Qqvc8DjW7sF.png"></p>
<p>å½“ç„¶å¯ä»¥ç›´æ¥çš„ä¿®æ”¹è¿™ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸ä¼šå‡ºç°ä»€ä¹ˆé”™è¯¯ï¼Œæˆ‘ä»¬ç›´æ¥ä¿®æ”¹<code>_state.data</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">store.<span class="property">_state</span>.<span class="property">data</span>.<span class="property">age</span> = <span class="number">23</span>;</span><br><span class="line"><span class="comment">// æˆ–è€…</span></span><br><span class="line"><span class="comment">// store.state.age = 23</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ— æ³•ä¿®æ”¹</span></span><br><span class="line"><span class="comment">// store.state = &#123;</span></span><br><span class="line"><span class="comment">//   age: 23</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œè¦æ³¨æ„ï¼Œ<code>set</code>åªæ˜¯å¯¹è®¾ç½®<code>state</code>è¿™ä¸ªæ“ä½œæ‹¦æˆª</p>
<p>è€Œæ— æ³•é€’å½’çš„æ‹¦æˆªï¼Œæ‰€ä»¥<code>store.state.age = 23</code>ä»é€»è¾‘ä¸Šå¹¶ä¸ä¼šæ‰§è¡Œ<code>state</code>çš„<code>set</code>ï¼Œè€Œæ˜¯æ‰§è¡Œ<code>state</code>çš„<code>get</code></p>
<p>æ‰“å°çœ‹çœ‹</p>
<p><img data-src="https://i.loli.net/2020/10/21/qrJdgFo7iuScPja.png"></p>
<p>å‘ç°ç¡®å®æ”¹å˜ï¼Œä¹Ÿæ²¡æœ‰å‡ºç°ä»»ä½•é”™è¯¯ï¼ˆè¿™é‡Œæ²¡æŠ¥é”™æ˜¯å› ä¸ºé»˜è®¤æƒ…å†µä¸‹ä¸¥æ ¼æ¨¡å¼æ˜¯å…³é—­çš„ï¼‰</p>
<p>å½“ç„¶è¿™æ ·å­ä¿®æ”¹çŠ¶æ€æ˜¯ä¸åº”è¯¥å‡ºç°åœ¨å®é™…çš„ä»£ç ä¸­çš„ï¼Œå› ä¸ºè¿™ä¼šä½¿å¾—çŠ¶æ€çš„æ”¹å˜å˜å¾—æ··ä¹±ã€‚</p>
<h2 id="constructor-NaN"><a href="#constructor-NaN" class="headerlink" title="constructor"></a><code>constructor</code></h2><p>æ–°å»ºä¸€ä¸ª<code>store</code>æ—¶çš„åˆå§‹åŒ–è¿‡ç¨‹</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Store</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span> (<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// Vuexéœ€è¦Promiseæ”¯æŒï¼Œä»¥åŠå¿…é¡»ä»¥newæ¥æ–°å»ºä¸€ä¸ªstore</span></span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="title function_">assert</span>(<span class="keyword">typeof</span> <span class="title class_">Promise</span> !== <span class="string">&#x27;undefined&#x27;</span>, <span class="string">`vuex requires a Promise polyfill in this browser.`</span>)</span><br><span class="line">      <span class="title function_">assert</span>(<span class="variable language_">this</span> <span class="keyword">instanceof</span> <span class="title class_">Store</span>, <span class="string">`store must be called with the new operator.`</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">      plugins = [],</span><br><span class="line">      <span class="comment">// ä¸¥æ ¼æ¨¡å¼é»˜è®¤ä¸å¼€</span></span><br><span class="line">      strict = <span class="literal">false</span></span><br><span class="line">    &#125; = options</span><br><span class="line"></span><br><span class="line">    <span class="comment">// storeçš„å†…éƒ¨å˜é‡ï¼Œå¯ä»¥çœ‹åˆ°ä»¥å•ä¸ª&#x27;_&#x27;å¼€å¤´ï¼Œæ˜¯å¾ˆå¥½çš„ç¼–ç ä¹ æƒ¯</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_committing</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_actions</span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_actionSubscribers</span> = []</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_mutations</span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_wrappedGetters</span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_modules</span> = <span class="keyword">new</span> <span class="title class_">ModuleCollection</span>(options)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_modulesNamespaceMap</span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_subscribers</span> = []</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_makeLocalGettersCache</span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŒ…è£…dispatchå’Œcommitå‡½æ•°ï¼Œç»‘å®šä¸Šä¸‹æ–‡</span></span><br><span class="line">    <span class="keyword">const</span> store = <span class="variable language_">this</span></span><br><span class="line">    <span class="keyword">const</span> &#123; dispatch, commit &#125; = <span class="variable language_">this</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dispatch</span> = <span class="keyword">function</span> <span class="title function_">boundDispatch</span> (<span class="params">type, payload</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> dispatch.<span class="title function_">call</span>(store, type, payload)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">commit</span> = <span class="keyword">function</span> <span class="title function_">boundCommit</span> (<span class="params">type, payload, options</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> commit.<span class="title function_">call</span>(store, type, payload, options)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŒ‚è½½ä¸¥æ ¼æ¨¡å¼çš„æ ‡å¿—</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">strict</span> = strict</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> state = <span class="variable language_">this</span>.<span class="property">_modules</span>.<span class="property">root</span>.<span class="property">state</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// init root module.</span></span><br><span class="line">    <span class="comment">// this also recursively registers all sub-modules</span></span><br><span class="line">    <span class="comment">// and collects all module getters inside this._wrappedGetters</span></span><br><span class="line">    <span class="title function_">installModule</span>(<span class="variable language_">this</span>, state, [], <span class="variable language_">this</span>.<span class="property">_modules</span>.<span class="property">root</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// initialize the store state, which is responsible for the reactivity</span></span><br><span class="line">    <span class="comment">// (also registers _wrappedGetters as computed properties)</span></span><br><span class="line">    <span class="title function_">resetStoreState</span>(<span class="variable language_">this</span>, state)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// apply plugins</span></span><br><span class="line">    plugins.<span class="title function_">forEach</span>(<span class="function"><span class="params">plugin</span> =&gt;</span> <span class="title function_">plugin</span>(<span class="variable language_">this</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> useDevtools = options.<span class="property">devtools</span> !== <span class="literal">undefined</span> ? options.<span class="property">devtools</span> : <span class="comment">/* Vue.config.devtools */</span> <span class="literal">true</span></span><br><span class="line">    <span class="keyword">if</span> (useDevtools) &#123;</span><br><span class="line">      <span class="title function_">devtoolPlugin</span>(<span class="variable language_">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€å‰é¢çš„ä¸¤ä¸ª<code>assert</code>åˆ¤æ–­è¡¨æ˜<code>Vuex</code>éœ€è¦<code>Promise</code>æ”¯æŒä»¥åŠå¿…é¡»é€šè¿‡<code>new</code>æ¥åˆ›å»º</p>
<p>å¯ä»¥çœ‹åˆ°åˆå§‹åŒ–äº†å¾ˆå¤šçš„å±æ€§</p>
<ul>
<li><code>strict</code> ä¸¥æ ¼æ¨¡å¼çš„å¼€å¯æ ‡å¿—</li>
<li><code>_committing</code> è·Ÿä¸¥æ ¼æ¨¡å¼ç›¸å…³ï¼Œä½¿å¾—å³ä½¿å¼€å¯ä¸¥æ ¼æ¨¡å¼ä¸‹ä¹Ÿå¯ä»¥ä¿®æ”¹çŠ¶æ€<code>_state.data</code></li>
<li><code>_actions</code> å­˜æ”¾æ‰€æœ‰çš„<code>action</code></li>
<li><code>_actionSubscribers</code> å­˜æ”¾æ‰€æœ‰çš„æ³¨å†Œ<code>action</code>å›è°ƒå‡½æ•°</li>
<li><code>_mutations</code> å­˜æ”¾æ‰€æœ‰<code>mutation</code></li>
<li><code>_subscribers</code> å­˜æ”¾æ‰€æœ‰çš„æ³¨å†Œ<code>mutation</code>å›è°ƒå‡½æ•°</li>
<li><code>_wrappedGetters</code> å­˜æ”¾æ‰€æœ‰çš„ç»‘å®šå‚æ•°çš„<code>getter</code></li>
<li><code>_modules</code> åµŒå¥—çš„æ¨¡å—åˆ—è¡¨</li>
<li><code>_modulesNamespaceMap</code> å¸¦å‘½åç©ºé—´çš„æ¨¡å—åˆ—è¡¨</li>
<li><code>_makeLocalGettersCache</code> å¸¦å‘½åç©ºé—´çš„æ¨¡å—çš„æ‰€æœ‰<code>getter</code>çš„ç¼“å­˜</li>
</ul>
<p>åœ¨åˆå§‹åŒ–äº†å±æ€§ä¹‹åï¼Œç»‘å®šäº†<code>dispatch</code>å’Œ<code>commit</code>çš„<code>context</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = <span class="variable language_">this</span></span><br><span class="line"><span class="keyword">const</span> &#123; dispatch, commit &#125; = <span class="variable language_">this</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">dispatch</span> = <span class="keyword">function</span> <span class="title function_">boundDispatch</span> (<span class="params">type, payload</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> dispatch.<span class="title function_">call</span>(store, type, payload)</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">commit</span> = <span class="keyword">function</span> <span class="title function_">boundCommit</span> (<span class="params">type, payload, options</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> commit.<span class="title function_">call</span>(store, type, payload, options)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸ºå•¥è¦è¿™æ ·å†™å‘¢ï¼ŒåŸå› å°±æ˜¯å¦‚æœæˆ‘ä»¬æŠŠå¯¹è±¡çš„å‡½æ•°èµ‹å€¼ç»™ä¸€ä¸ªå˜é‡ï¼Œé‚£ä¹ˆæ­¤æ—¶çš„<code>this</code>ä¼šä¸¢å¤±ï¼Œæ¯”å¦‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> o = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;lwf&quot;</span>,</span><br><span class="line">  <span class="title function_">say</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">name</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">o.<span class="title function_">say</span>();  <span class="comment">// æ²¡é—®é¢˜ï¼Œè¾“å‡º &quot;lwf&quot;</span></span><br><span class="line"><span class="keyword">const</span> say = o.<span class="property">say</span>;</span><br><span class="line"><span class="title function_">say</span>();    <span class="comment">// æ­¤æ—¶thisæŒ‡å‘äº†windowï¼Œè¾“å‡ºäº†&quot;undefined&quot;</span></span><br></pre></td></tr></table></figure>

<p>ç»‘å®šäº†ä¸Šä¸‹æ–‡ï¼Œè¿™æ ·ç”¨æˆ·å¦‚æœä½¿ç”¨è§£æ„ä¹‹ç±»çš„æ“ä½œï¼Œä¹Ÿä¸ä¼šé€ æˆä¸Šä¸‹æ–‡çš„ä¸¢å¤±</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; dispatch, commit &#125; = store;</span><br><span class="line"></span><br><span class="line"><span class="title function_">commit</span>(...)      <span class="comment">// æ²¡æœ‰é—®é¢˜</span></span><br><span class="line"><span class="title function_">dispatch</span>(...)    <span class="comment">// æ²¡æœ‰é—®é¢˜</span></span><br></pre></td></tr></table></figure>

<p>ç„¶ååˆå§‹åŒ–äº†<code>strict</code>ä¸¥æ ¼æ¨¡å¼æ ‡å¿—ï¼Œå¹¶ä¸”ä¸¥æ ¼æ¨¡å¼é»˜è®¤ä¸å¼€ï¼Œä»å¯¹<code>options</code>çš„è§£æ„å¯ä»¥çœ‹å‡ºï¼Œ<code>strict</code>çš„é»˜è®¤å€¼ä¸º<code>false</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;</span><br><span class="line">  plugins = [],</span><br><span class="line">  <span class="comment">// ä¸¥æ ¼æ¨¡å¼é»˜è®¤ä¸å¼€</span></span><br><span class="line">  strict = <span class="literal">false</span></span><br><span class="line">&#125; = options</span><br><span class="line"><span class="comment">// ...å…¶ä»–ä»£ç </span></span><br><span class="line"><span class="comment">// strict mode</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">strict</span> = strict</span><br></pre></td></tr></table></figure>

<p>å¯¹äºä¸¥æ ¼å‡½æ•°ï¼Œå¯ä»¥å…ˆçœ‹<code>enableStrictMode</code>è¿™ä¸ªå‡½æ•°ï¼ˆæ³¨æ„ï¼Œè¿™ä¸ªå‡½æ•°ä¸åœ¨ç±»ä¸­ï¼ŒåŒä¸€ä¸ªæ–‡ä»¶å†…å¾€ä¸‹æ‹‰å¯ä»¥æ‰¾åˆ°ï¼‰</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">enableStrictMode</span> (<span class="params">store</span>) &#123;</span><br><span class="line">  <span class="title function_">watch</span>(<span class="function">() =&gt;</span> store.<span class="property">_state</span>.<span class="property">data</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="title function_">assert</span>(store.<span class="property">_committing</span>, <span class="string">`do not mutate vuex store state outside mutation handlers.`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, &#123; <span class="attr">deep</span>: <span class="literal">true</span>, <span class="attr">flush</span>: <span class="string">&#x27;sync&#x27;</span> &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªå‡½æ•°å†…éƒ¨ä½¿ç”¨äº†<code>Vue3</code>çš„<code>watch</code>API</p>
<p>ç›‘å¬äº†<code>store._state.data</code>è¿™ä¸ªå¯¹è±¡ï¼Œé…ç½®ä¸º<code>deep</code>ï¼ˆæ·±å±‚ç›‘å¬ï¼‰å¹¶ä¸”æ‰§è¡Œä¸º<code>sync</code>ï¼ˆåŒæ­¥çš„ï¼‰</p>
<p>åœ¨å›è°ƒå‡½æ•°å†…éƒ¨ï¼Œå¼€å‘æ¨¡å¼<code>__DEV__</code>ä¸‹ä¼šæ ¹æ®<code>store._committing</code>çŠ¶æ€æ¥åˆ¤æ–­æ˜¯å¦è¦æŠ›å‡ºé”™è¯¯</p>
<p>æˆ‘ä»¬å¯ä»¥è¯•è¯•é…ç½®ä¸‹<code>strict</code>ä¸º<code>true</code>ï¼Œç„¶åæ‰“å°æ¥çœ‹çœ‹æ•ˆæœ</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = <span class="title function_">createStore</span>(&#123;</span><br><span class="line">  <span class="attr">strict</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">state</span>: &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;lwf&quot;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">22</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line">store.<span class="property">_state</span>.<span class="property">data</span>.<span class="property">age</span> = <span class="number">23</span>;</span><br></pre></td></tr></table></figure>

<p><img data-src="https://i.loli.net/2020/10/22/5wb13tfjiXrLPYR.png"></p>
<p>æŠ¥é”™äº†ï¼Œä½†æ•°æ®è¿˜æ˜¯æ›´æ”¹äº†ï¼ˆæ‰€ä»¥è¿˜æ˜¯è¦æ ¹æ®<code>Vuex</code>çš„è®¾è®¡ç†å¿µæ¥ï¼Œè€Œä¸æ˜¯ç›´æ¥ä¿®æ”¹æ•°æ®ï¼‰</p>
<p><img data-src="https://i.loli.net/2020/10/22/rANBkSZ6CJ28il4.png"></p>
<p>æœ‰ä¸€ä¸ªå‡½æ•°å’Œ<code>enableStrictMode</code>å­˜åœ¨å…³ç³»ï¼Œå°±æ˜¯åœ¨è¿™ä¸ªç±»ä¸­çš„<code>_withCommit</code>æ–¹æ³•</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Store</span> &#123;</span><br><span class="line">  <span class="title function_">_withCommit</span> (fn) &#123;</span><br><span class="line">    <span class="comment">// ä¿å­˜ä¹‹å‰çš„çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">const</span> committing = <span class="variable language_">this</span>.<span class="property">_committing</span></span><br><span class="line">    <span class="comment">// ç½®ä¸ºçœŸï¼Œè¿™æ ·ä¿®æ”¹_state.dataä¸æŠ¥é”™ï¼Œå³ä½¿åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_committing</span> = <span class="literal">true</span></span><br><span class="line">    <span class="title function_">fn</span>()</span><br><span class="line">    <span class="comment">// æ¢å¤ä¹‹å‰çš„çŠ¶æ€</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_committing</span> = committing</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªå‡½æ•°ä½¿å¾—å†…éƒ¨ä¿®æ”¹<code>_state.data</code>ä¸æŠ¥é”™ï¼ˆå³ä½¿åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹ï¼Œä¸è¿‡ç°åœ¨è¿˜æ²¡å†™åˆ°å®ƒåœ¨ä»€ä¹ˆåœ°æ–¹å¼€å¯ï¼‰</p>
<p>å› ä¸º<code>_committing</code>è¢«ç½®ä¸º<code>true</code></p>
<p>æ¥ç€æ‰§è¡Œäº†ä¸¤ä¸ªå‡½æ•°<code>installModule</code>å’Œ<code>resetStoreState</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> state = <span class="variable language_">this</span>.<span class="property">_modules</span>.<span class="property">root</span>.<span class="property">state</span></span><br><span class="line"><span class="title function_">installModule</span>(<span class="variable language_">this</span>, state, [], <span class="variable language_">this</span>.<span class="property">_modules</span>.<span class="property">root</span>)</span><br><span class="line"><span class="title function_">resetStoreState</span>(<span class="variable language_">this</span>, state)</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>installModule</code>ä¸Šæœ‰ä¸€è¡Œæ³¨é‡Š</p>
<blockquote>
<p>init root module.this also recursively registers all sub-modules and<br>collects all module getters inside this._wrappedGetters</p>
</blockquote>
<p>å¤§æ„å°±æ˜¯ï¼Œåˆå§‹åŒ–æ ¹æ¨¡å—ï¼Œé€’å½’æ³¨å†Œæ‰€æœ‰å­æ¨¡å—ï¼Œæ”¶é›†æ‰€æœ‰æ¨¡å—çš„<code>getters</code>åˆ°<code>_wrappedGetters</code>ä¸‹</p>
<p>åœ¨<code>resetStoreState</code>ä¸Šæœ‰ä¸€è¡Œæ³¨é‡Š</p>
<blockquote>
<p>initialize the store state, which is responsible for the reactivity<br>(also registers _wrappedGetters as computed properties)</p>
</blockquote>
<p>å¤§æ„å°±æ˜¯ï¼Œåˆå§‹åŒ–<code>store</code>çš„çŠ¶æ€ï¼Œé€šè¿‡<code>reactive</code>APIä½¿ä¹‹æˆä¸ºå“åº”å¼çš„ï¼ˆ<code>reactive</code>ï¼‰</p>
<p>å¹¶ä¸”ä¹Ÿä¼šæ³¨å†Œ<code>wrappedGetters</code>é‡Œé¢çš„æ‰€æœ‰<code>getter</code>åˆ°<code>store.getter</code>ä¸‹ï¼Œä½¿ä¹‹æˆä¸ºä¸€ä¸ªè®¡ç®—å±æ€§ï¼ˆ<code>computed</code>ï¼‰ã€‚</p>
<p>ï¼ˆè¿™ä¸¤ä¸ªå‡½æ•°åé¢å†™ï¼Œå…ˆè®¤è¯†æ€»ä½“çš„æµç¨‹ï¼Œå¦‚æœæƒ³æŸ¥çœ‹ï¼Œç‚¹å‡»å³ä¾§ç›¸åº”çš„éƒ¨åˆ†å³å¯è·³è½¬ï¼‰</p>
<p>éå†æ’ä»¶æ•°ç»„ï¼Œå®‰è£…æ’ä»¶</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// apply plugins</span></span><br><span class="line">plugins.<span class="title function_">forEach</span>(<span class="function"><span class="params">plugin</span> =&gt;</span> <span class="title function_">plugin</span>(<span class="variable language_">this</span>))</span><br></pre></td></tr></table></figure>

<p>å¯¹äºæ’ä»¶çš„å®‰è£…ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆé­”æ³•ï¼Œä¼ å…¥äº†è‡ªå·±ä½œä¸ºå‚æ•°ï¼Œç„¶åæ‰§è¡Œï¼Œä»…æ­¤è€Œå·²ã€‚</p>
<p><code>Vuex</code>çš„æ–‡æ¡£ä¸Šç»™äº†ä¸€ä¸ªç®€å•çš„ä¾‹å­</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">myPlugin</span> = store =&gt; &#123;</span><br><span class="line">  <span class="comment">// å½“ store åˆå§‹åŒ–åè°ƒç”¨</span></span><br><span class="line">  store.<span class="title function_">subscribe</span>(<span class="function">(<span class="params">mutation, state</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// æ¯æ¬¡ mutation ä¹‹åè°ƒç”¨</span></span><br><span class="line">    <span class="comment">// mutation çš„æ ¼å¼ä¸º &#123; type, payload &#125;</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å†…éƒ¨è‡ªå¸¦çš„<code>logger.js</code>ä¹Ÿæ˜¯é€šè¿‡è¿™ç§æ–¹å¼è¿›è¡Œå®‰è£…ï¼Œæ–‡ä»¶ä½äº<code>plugins</code>æ–‡ä»¶å¤¹ä¸‹</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createLogger</span> (<span class="params"></span></span><br><span class="line"><span class="params">  <span class="comment">/* ...args */</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// è¿”å›äº†ä¸€ä¸ªå‡½æ•°ï¼Œå‡½æ•°çš„å‚æ•°ä¸ºstore</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">store</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// ...code</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åæ˜¯åˆ¤æ–­æ˜¯å¦å®‰è£…å¼€å‘å·¥å…·æ’ä»¶çš„ä»£ç ï¼ˆè¿™ä¸ªæ’ä»¶ä¾èµ–äº†è°ƒè¯•å·¥å…·æš´éœ²çš„å¯¹è±¡ï¼Œå®ç°å…¶å®éå¸¸ç®€å•ï¼Œä½†è¿™é‡Œå¿½ç•¥ä¸å†™ï¼Œå› ä¸ºå’Œæ ¸å¿ƒå®ç°æ²¡æœ‰å¤ªå¤§å…³ç³»ï¼‰</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> useDevtools = options.<span class="property">devtools</span> !== <span class="literal">undefined</span> ? options.<span class="property">devtools</span> : <span class="comment">/* Vue.config.devtools */</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">if</span> (useDevtools) &#123;</span><br><span class="line">  <span class="title function_">devtoolPlugin</span>(<span class="variable language_">this</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="commit"><a href="#commit" class="headerlink" title="commit"></a><code>commit</code></h2><p><code>commit</code>ç”¨äºæäº¤ä¸€ä¸ª<code>mutation</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Store</span> &#123;</span><br><span class="line">  <span class="title function_">commit</span> (_type, _payload, _options) &#123;</span><br><span class="line">    <span class="comment">// check object-style commit</span></span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">      type,</span><br><span class="line">      payload,</span><br><span class="line">      options</span><br><span class="line">    &#125; = <span class="title function_">unifyObjectStyle</span>(_type, _payload, _options)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mutation = &#123; type, payload &#125;</span><br><span class="line">    <span class="keyword">const</span> entry = <span class="variable language_">this</span>.<span class="property">_mutations</span>[type]</span><br><span class="line">    <span class="keyword">if</span> (!entry) &#123;</span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`[vuex] unknown mutation type: <span class="subst">$&#123;type&#125;</span>`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">_withCommit</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      entry.<span class="title function_">forEach</span>(<span class="keyword">function</span> <span class="title function_">commitIterator</span> (<span class="params">handler</span>) &#123;</span><br><span class="line">        <span class="title function_">handler</span>(payload)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_subscribers</span></span><br><span class="line">      .<span class="title function_">slice</span>() <span class="comment">// shallow copy to prevent iterator invalidation if subscriber synchronously calls unsubscribe</span></span><br><span class="line">      .<span class="title function_">forEach</span>(<span class="function"><span class="params">sub</span> =&gt;</span> <span class="title function_">sub</span>(mutation, <span class="variable language_">this</span>.<span class="property">state</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      __DEV__ &amp;&amp;</span><br><span class="line">      options &amp;&amp; options.<span class="property">silent</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(</span><br><span class="line">        <span class="string">`[vuex] mutation type: <span class="subst">$&#123;type&#125;</span>. Silent option has been removed. `</span> +</span><br><span class="line">        <span class="string">&#x27;Use the filter functionality in the vue-devtools&#x27;</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>unifyObjectStyle</code>å¯¹å…¥å‚è¿›è¡Œæ ‡å‡†åŒ–</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// check object-style commit</span></span><br><span class="line"><span class="keyword">const</span> &#123;</span><br><span class="line">  type,</span><br><span class="line">  payload,</span><br><span class="line">  options</span><br><span class="line">&#125; = <span class="title function_">unifyObjectStyle</span>(_type, _payload, _options)</span><br></pre></td></tr></table></figure>

<p><code>unifyObjectStyle</code>è§„èŒƒäº†å‚æ•°ï¼Œåœ¨<code>Vuex</code>ä¸­ï¼Œ<code>commit</code>ä¸€ä¸ª<code>mutation</code>çš„æ–¹å¼æœ‰å¤šç§ï¼Œæ¯”å¦‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. mutationåå­— + è½½è· + options</span></span><br><span class="line">store.<span class="title function_">commit</span>(<span class="string">&quot;mutation1&quot;</span>, &#123;</span><br><span class="line">  <span class="comment">// è‡ªå®šä¹‰çš„è½½è·</span></span><br><span class="line">&#125;, &#123;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. åŒ…å«mutationåå­—çš„è½½è· + options</span></span><br><span class="line">store.<span class="title function_">commit</span>(&#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&quot;mutation1&quot;</span></span><br><span class="line">  <span class="comment">// è‡ªå®šä¹‰çš„è½½è·</span></span><br><span class="line">&#125;, &#123;&#125;);</span><br></pre></td></tr></table></figure>

<p><code>unifyObjectStyle</code>å®ç°å¦‚ä¸‹</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">unifyObjectStyle</span> (<span class="params">type, payload, options</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isObject</span>(type) &amp;&amp; type.<span class="property">type</span>) &#123;</span><br><span class="line">    options = payload</span><br><span class="line">    payload = type</span><br><span class="line">    type = type.<span class="property">type</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="title function_">assert</span>(<span class="keyword">typeof</span> type === <span class="string">&#x27;string&#x27;</span>, <span class="string">`expects string as the type, but found <span class="subst">$&#123;<span class="keyword">typeof</span> type&#125;</span>.`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123; type, payload, options &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¯¹è±¡ï¼Œé‚£ä¹ˆç¬¬äºŒä¸ªå‚æ•°å°±åº”è¯¥æ˜¯<code>options</code>ï¼Œ<code>mutation</code>çš„åå­—åº”è¯¥ä¸ºç¬¬ä¸€ä¸ªå‚æ•°çš„<code>type</code>ï¼Œè½½è·å°±æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°ã€‚</p>
<p>å¦‚æœç¬¬ä¸€ä¸ªå‚æ•°ä¸æ˜¯å¯¹è±¡ï¼Œé‚£ä¹ˆå°±æ˜¯ä¸‰ä¸ªå‚æ•°çš„æƒ…å†µï¼Œç›´æ¥è¿”å›å³å¯</p>
<p>æ³¨æ„åˆ°ä¸­é—´è¿˜åˆ¤æ–­äº†<code>mutation</code>çš„åå­—ä¸€å®šè¦æ˜¯å­—ç¬¦ä¸²ï¼Œä¸ç„¶æŠ¥é”™</p>
<p>æ¥ç€ä»<code>_mutations</code>å±æ€§ä¸­æ‹¿å‡ºäº†å¯¹åº”<code>type</code>çš„å‡½æ•°æ•°ç»„</p>
<p>æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªåå­—ä¸º<code>m1</code>çš„<code>mutation</code>æ˜¯å¯ä»¥å¯¹åº”å¤šä¸ªå‡½æ•°çš„</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mutation = &#123; type, payload &#125;</span><br><span class="line"><span class="keyword">const</span> entry = <span class="variable language_">this</span>.<span class="property">_mutations</span>[type]</span><br><span class="line"><span class="keyword">if</span> (!entry) &#123;</span><br><span class="line">  <span class="comment">// æ²¡è¿™ä¸ªåå­—å¯¹åº”çš„å‡½æ•°ï¼Œè¯æ˜æ²¡æœ‰æ³¨å†Œè¿‡ï¼Œå¼€å‘ç¯å¢ƒä¸‹æŠ¥é”™</span></span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`[vuex] unknown mutation type: <span class="subst">$&#123;type&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åæ‰§è¡Œäº†<code>_withCommit</code>æ¥ä¿®æ”¹çŠ¶æ€ï¼ˆé˜²<code>strict</code>ä¸º<code>true</code>ä¸‹æŠ¥é”™ï¼‰</p>
<p>å¯¹æ¯ä¸ª<code>mutation</code>ä¼ å…¥äº†è½½è·ï¼ˆè‡ªå®šä¹‰çš„å‚æ•°ï¼‰ï¼Œæ³¨æ„è¿™é‡Œæ˜¯ä¸€ä¸ªå®Œå…¨åŒæ­¥æ‰§è¡Œçš„è¿‡ç¨‹</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="title function_">_withCommit</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  entry.<span class="title function_">forEach</span>(<span class="keyword">function</span> <span class="title function_">commitIterator</span> (<span class="params">handler</span>) &#123;</span><br><span class="line">    <span class="title function_">handler</span>(payload)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>ç„¶åè¿›è¡Œå›è°ƒçš„æ‰§è¡Œ</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">_subscribers</span></span><br><span class="line">      .<span class="title function_">slice</span>() <span class="comment">// shallow copy to prevent iterator invalidation if subscriber synchronously calls unsubscribe</span></span><br><span class="line">      .<span class="title function_">forEach</span>(<span class="function"><span class="params">sub</span> =&gt;</span> <span class="title function_">sub</span>(mutation,  <span class="variable language_">this</span>.<span class="property">state</span>))</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„è¿™é‡Œè°ƒç”¨äº†<code>slice</code>è¿”å›äº†ä¸€ä¸ªæµ…å¤åˆ¶çš„å‰¯æœ¬</p>
<p>è¿™ä¹ˆåšä¸ºäº†é˜²æ­¢åœ¨æ³¨å†Œçš„å‡½æ•°ä¸­æ‰§è¡Œå–æ¶ˆæ³¨å†Œè€Œé€ æˆçš„é€»è¾‘æ··ä¹±é—®é¢˜ï¼ˆ<code>Redux</code>å†…éƒ¨ä¹Ÿæœ‰ç›¸ä¼¼çš„é€»è¾‘ï¼‰</p>
<p>æœ€åä¸€ä¸ªåˆ¤æ–­å’Œå¼€å‘å·¥å…·ç›¸å…³ï¼Œå¿½ç•¥</p>
<h2 id="dispatch"><a href="#dispatch" class="headerlink" title="dispatch"></a><code>dispatch</code></h2><p><code>dispatch</code>ç”¨äºåˆ†å‘ä¸€ä¸ª<code>action</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Store</span>&#123;</span><br><span class="line">  <span class="title function_">dispatch</span> (_type, _payload) &#123;</span><br><span class="line">    <span class="comment">// check object-style dispatch</span></span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">      type,</span><br><span class="line">      payload</span><br><span class="line">    &#125; = <span class="title function_">unifyObjectStyle</span>(_type, _payload)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> action = &#123; type, payload &#125;</span><br><span class="line">    <span class="keyword">const</span> entry = <span class="variable language_">this</span>.<span class="property">_actions</span>[type]</span><br><span class="line">    <span class="keyword">if</span> (!entry) &#123;</span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`[vuex] unknown action type: <span class="subst">$&#123;type&#125;</span>`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_actionSubscribers</span></span><br><span class="line">        .<span class="title function_">slice</span>() <span class="comment">// shallow copy to prevent iterator invalidation if subscriber synchronously calls unsubscribe</span></span><br><span class="line">        .<span class="title function_">filter</span>(<span class="function"><span class="params">sub</span> =&gt;</span> sub.<span class="property">before</span>)</span><br><span class="line">        .<span class="title function_">forEach</span>(<span class="function"><span class="params">sub</span> =&gt;</span> sub.<span class="title function_">before</span>(action, <span class="variable language_">this</span>.<span class="property">state</span>))</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`[vuex] error in before action subscribers: `</span>)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(e)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> result = entry.<span class="property">length</span> &gt; <span class="number">1</span></span><br><span class="line">      ? <span class="title class_">Promise</span>.<span class="title function_">all</span>(entry.<span class="title function_">map</span>(<span class="function"><span class="params">handler</span> =&gt;</span> <span class="title function_">handler</span>(payload)))</span><br><span class="line">      : entry[<span class="number">0</span>](payload)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      result.<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">_actionSubscribers</span></span><br><span class="line">            .<span class="title function_">filter</span>(<span class="function"><span class="params">sub</span> =&gt;</span> sub.<span class="property">after</span>)</span><br><span class="line">            .<span class="title function_">forEach</span>(<span class="function"><span class="params">sub</span> =&gt;</span> sub.<span class="title function_">after</span>(action, <span class="variable language_">this</span>.<span class="property">state</span>))</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">          <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`[vuex] error in after action subscribers: `</span>)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(e)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">resolve</span>(res)</span><br><span class="line">      &#125;, <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">_actionSubscribers</span></span><br><span class="line">            .<span class="title function_">filter</span>(<span class="function"><span class="params">sub</span> =&gt;</span> sub.<span class="property">error</span>)</span><br><span class="line">            .<span class="title function_">forEach</span>(<span class="function"><span class="params">sub</span> =&gt;</span> sub.<span class="title function_">error</span>(action, <span class="variable language_">this</span>.<span class="property">state</span>, error))</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">          <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`[vuex] error in error action subscribers: `</span>)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(e)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">reject</span>(error)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>dispatch</code>çš„å‚æ•°ä¼ å…¥æ–¹å¼å’Œ<code>commit</code>åŸºæœ¬ä¸€æ ·ï¼Œæ‰€ä»¥å‡½æ•°å‰é¢çš„é€»è¾‘ä¹Ÿæ˜¯è§„èŒƒå‚æ•°ï¼Œæå–ç›¸åº”çš„éƒ¨åˆ†</p>
<p>ç„¶åè°ƒç”¨äº†é‚£äº›æ³¨å†Œçš„<code>before</code>çš„å‡½æ•°ï¼Œè¿™é‡Œç”¨<code>try-catch</code>ï¼Œé˜²æ­¢<code>before</code>å‡½æ•°æ‰§è¡Œå‡ºç°é”™è¯¯å¯¼è‡´åç»­<code>dispatch</code>æ“ä½œæ‰§è¡Œå¤±è´¥</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_actionSubscribers</span></span><br><span class="line">    .<span class="title function_">slice</span>() <span class="comment">// shallow copy to prevent iterator invalidation if subscriber synchronously calls unsubscribe</span></span><br><span class="line">    .<span class="title function_">filter</span>(<span class="function"><span class="params">sub</span> =&gt;</span> sub.<span class="property">before</span>)</span><br><span class="line">    .<span class="title function_">forEach</span>(<span class="function"><span class="params">sub</span> =&gt;</span> sub.<span class="title function_">before</span>(action, <span class="variable language_">this</span>.<span class="property">state</span>))</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`[vuex] error in before action subscribers: `</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(e)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯¹äºæ³¨å†Œåœ¨<code>action</code>çš„å›è°ƒï¼Œæœ‰ä¸‰ç§æ–¹å¼æ¥æ‰§è¡Œå›è°ƒ</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">store.<span class="title function_">subscribeAction</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// é»˜è®¤before</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">store.<span class="title function_">subscribeAction</span>(&#123;</span><br><span class="line">  <span class="attr">before</span>: <span class="function">() =&gt;</span> &#123;&#125;,   <span class="comment">// action åˆ†å‘ä¹‹å‰</span></span><br><span class="line">  <span class="attr">after</span>: <span class="function">() =&gt;</span> &#123;&#125;,    <span class="comment">// aciton åˆ†å‘ä¹‹å</span></span><br><span class="line">  <span class="attr">error</span>: <span class="function">() =&gt;</span> &#123;&#125;     <span class="comment">// aciton åˆ†å‘å‡ºç°é”™è¯¯</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥ä¸Šé¢çš„ <code>.filter(sub =&gt; sub.before)</code>é€»è¾‘æŠŠ<code>before</code>çš„å‡½æ•°ç»™ç­›äº†å‡ºæ¥</p>
<p>æ³¨æ„è¿™é‡Œä¹Ÿåšäº†ä¸€ä¸ª<code>slice</code>æµ…æ‹·è´ï¼Œé˜²æ­¢å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­å–æ¶ˆæ³¨å†Œï¼ˆæˆ–è€…è¯´æ˜¯â€œå–æ¶ˆè®¢é˜…â€ï¼‰</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> result = entry.<span class="property">length</span> &gt; <span class="number">1</span></span><br><span class="line">      ? <span class="title class_">Promise</span>.<span class="title function_">all</span>(entry.<span class="title function_">map</span>(<span class="function"><span class="params">handler</span> =&gt;</span> <span class="title function_">handler</span>(payload)))</span><br><span class="line">      : entry[<span class="number">0</span>](payload)</span><br></pre></td></tr></table></figure>

<p>ç„¶åæ‰§è¡Œäº†ç›¸åº”çš„<code>action</code>å‡½æ•°ï¼Œè¿™é‡Œå’Œ<code>mutation</code>ä¸€æ ·ï¼Œéƒ½æ˜¯æ‰§è¡Œäº†ä¸€ä¸ªæ•°ç»„ï¼Œä¹Ÿå°±æ˜¯å­˜åœ¨å¤šä¸ªçš„<code>action</code></p>
<p>è¿™é‡Œå¯èƒ½æœ‰ç–‘é—®ï¼Œä¸ºå•¥å¤šä¸ª<code>action</code>å‡½æ•°çš„æ—¶å€™å°±åŒ…äº†ä¸€å±‚<code>Promise.all</code>ï¼Œä¸€ä¸ªçš„æ—¶å€™å°±æ²¡æœ‰å‘¢ï¼Ÿ</p>
<p>è¿™æ˜¯å› ä¸ºåœ¨æ³¨å†Œ<code>action</code>çš„æ—¶å€™ï¼ˆ<code>registerAction</code>è¿™ä¸ªå‡½æ•°ï¼Œåé¢ä¼šå†™åˆ°å®ƒçš„å®ç°ï¼‰ï¼Œå·²ç»å¯¹<code>action</code>è¿›è¡ŒåŒ…è£…äº†ï¼Œä½¿å¾—æ¯ä¸ª<code>action</code>ä¸€å®šä¼šè¿”å›ä¸€ä¸ª<code>Promise</code></p>
<p>æœ€åè¿”å›äº†ä¸€ä¸ª<code>Promise</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  result.<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_actionSubscribers</span></span><br><span class="line">        .<span class="title function_">filter</span>(<span class="function"><span class="params">sub</span> =&gt;</span> sub.<span class="property">after</span>)</span><br><span class="line">        .<span class="title function_">forEach</span>(<span class="function"><span class="params">sub</span> =&gt;</span> sub.<span class="title function_">after</span>(action, <span class="variable language_">this</span>.<span class="property">state</span>))</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`[vuex] error in after action subscribers: `</span>)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(e)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">resolve</span>(res)</span><br><span class="line">  &#125;, <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_actionSubscribers</span></span><br><span class="line">        .<span class="title function_">filter</span>(<span class="function"><span class="params">sub</span> =&gt;</span> sub.<span class="property">error</span>)</span><br><span class="line">        .<span class="title function_">forEach</span>(<span class="function"><span class="params">sub</span> =&gt;</span> sub.<span class="title function_">error</span>(action, <span class="variable language_">this</span>.<span class="property">state</span>, error))</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`[vuex] error in error action subscribers: `</span>)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(e)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">reject</span>(error)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><code>action</code>å’Œ<code>mutation</code>çš„ä¸åŒä¹‹å¤„å°±æ˜¯<code>action</code>é‡Œé¢æ”¯æŒå¼‚æ­¥çš„æ“ä½œï¼Œè€Œ<code>mutation</code>é‡Œé¢ä¿®æ”¹<code>state</code>ä¸€å®šæ˜¯åŒæ­¥çš„</p>
<p>æ‰€ä»¥<code>dispatch</code>è¿”å›äº†ä¸€ä¸ª<code>Promise</code>ï¼Œåœ¨<code>action</code>æ‰§è¡Œå®Œæ¯•å¯ä»¥é€šè¿‡<code>then</code>æ³¨å†Œä¸€ä¸ªå›è°ƒ</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">dispatch</span>(<span class="string">&#x27;action1&#x27;</span>).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// dispatchæ‰§è¡Œå®Œæ¯•æ—¶çš„å›è°ƒ</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><code>dispatch</code>è¿”å›çš„<code>Promise</code>å¾ˆç®€å•ï¼Œæ ¹æ®<code>action</code>è¿”å›çš„<code>Promise</code>çŠ¶æ€æ¥å†³å®šå¦‚ä½•è§£å†³<code>dispatch</code>è¿”å›<code>Promise</code>çš„çŠ¶æ€</p>
<p>æˆåŠŸå›è°ƒæ‰§è¡Œäº†æ³¨å†Œä¸º<code>after</code>çš„å‡½æ•°ï¼Œé”™è¯¯å›è°ƒæ‰§è¡Œäº†æ³¨å†Œ<code>error</code>çš„å‡½æ•°</p>
<p>ç®€å•ç‚¹è®²ï¼Œå°±æ˜¯åŒ…äº†ä¸€å±‚<code>Promise</code>ï¼Œä¸ºäº†èƒ½å¤Ÿæ‰§è¡Œæ³¨å†Œçš„<code>after</code>å’Œ<code>error</code>å‡½æ•°ï¼ˆ<code>3.4.0</code>ç‰ˆæœ¬æ–°å¢çš„<code>API</code>ï¼‰</p>
<h2 id="subscribe"><a href="#subscribe" class="headerlink" title="subscribe"></a><code>subscribe</code></h2><p>æ³¨å†Œåœ¨<code>mutation</code>æ‰§è¡Œä¹‹åæ‰§è¡Œçš„å‡½æ•°</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Store</span> &#123;</span><br><span class="line">  <span class="title function_">subscribe</span> (fn, options) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">genericSubscribe</span>(fn, <span class="variable language_">this</span>.<span class="property">_subscribers</span>, options)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œå®ç°ä¾èµ–äº†å¦ä¸€ä¸ªå‡½æ•°<code>genericSubscribe</code>ï¼Œæ³¨å†Œ<code>mutation</code>å’Œ<code>action</code>éƒ½ä¾èµ–äº†è¿™ä¸ªå‡½æ•°</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">genericSubscribe</span> (<span class="params">fn, subs, options</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (subs.<span class="title function_">indexOf</span>(fn) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    options &amp;&amp; options.<span class="property">prepend</span></span><br><span class="line">      ? subs.<span class="title function_">unshift</span>(fn)</span><br><span class="line">      : subs.<span class="title function_">push</span>(fn)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> i = subs.<span class="title function_">indexOf</span>(fn)</span><br><span class="line">    <span class="keyword">if</span> (i &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">      subs.<span class="title function_">splice</span>(i, <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…ˆåˆ¤æ–­å‡½æ•°<code>fn</code>æ˜¯å¦å·²ç»åœ¨<code>subs</code>ä¸­äº†ï¼Œä¸å­˜åœ¨æ‰æ”¾è¿›å»</p>
<p><code>options</code>çš„<code>prepend</code>å¯ä»¥æŒ‡å®šæ€ä¹ˆæŠŠå‡½æ•°æ”¾åˆ°æ•°ç»„ä¸­</p>
<p>å¦‚æœ<code>prepend</code>ä¸º<code>true</code>ï¼Œé‚£ä¹ˆæ‰§è¡Œ<code>unshift</code>æ”¾åˆ°æ•°ç»„å¤´éƒ¨ï¼Œåä¹‹<code>push</code>åˆ°æ•°ç»„å°¾éƒ¨</p>
<p>è¿”å›äº†ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°é€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯æ‰¾åˆ°æ•°ç»„é‡Œé¢çš„è¿™ä¸ªå‡½æ•°ï¼Œç„¶åé€šè¿‡<code>splice</code>åˆ é™¤ï¼Œä¹Ÿå°±æ˜¯å–æ¶ˆæ³¨å†Œï¼ˆå–æ¶ˆè®¢é˜…ï¼‰</p>
<h2 id="subscribeAction"><a href="#subscribeAction" class="headerlink" title="subscribeAction"></a><code>subscribeAction</code></h2><p>æ³¨å†Œä¸€ä¸ªå‡½æ•°ï¼Œåœ¨<code>action</code>æ‰§è¡Œä¹‹å‰<code>before</code>ï¼ˆé»˜è®¤ï¼‰ï¼Œæ‰§è¡Œä¹‹å<code>after</code>å’Œæ‰§è¡Œå‡ºé”™<code>error</code>æ—¶æ‰§è¡Œ</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Store</span> &#123;</span><br><span class="line">  <span class="title function_">subscribeAction</span> (fn, options) &#123;</span><br><span class="line">    <span class="keyword">const</span> subs = <span class="keyword">typeof</span> fn === <span class="string">&#x27;function&#x27;</span> ? &#123; <span class="attr">before</span>: fn &#125; : fn</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">genericSubscribe</span>(subs, <span class="variable language_">this</span>.<span class="property">_actionSubscribers</span>, options)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°å…ˆåˆ¤æ–­ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¦ä¸ºå‡½æ•°æ¥åˆ¤æ–­æ˜¯å¦åŒ…è£…ä¸ºä¸€ä¸ªå¯¹è±¡</p>
<p>å¦‚æœç›´æ¥ä¼ å…¥äº†ä¸€ä¸ªå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯<code>typeof fn === &#39;function&#39;</code>ä¸ºçœŸï¼Œé‚£ä¹ˆåŒ…è£…æˆä¸€ä¸ª<code>&#123; before: fn &#125;</code></p>
<p>å¹¶ä¸”ä¹Ÿæ”¯æŒ<code>options</code>çš„<code>prepend</code>æ¥é…ç½®å‰æ’å…¥è¿˜æ˜¯åæ’å…¥æ•°ç»„</p>
<p><code>genericSubscribe</code>çš„å®ç°åœ¨<code>subscribe</code>æœ‰å†™ï¼Œè¿™é‡Œå°±ä¸é‡å¤äº†</p>
<h2 id="watch"><a href="#watch" class="headerlink" title="watch"></a><code>watch</code></h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Store</span> &#123;</span><br><span class="line">  <span class="title function_">watch</span> (getter, cb, options) &#123;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="title function_">assert</span>(<span class="keyword">typeof</span> getter === <span class="string">&#x27;function&#x27;</span>, <span class="string">`store.watch only accepts a function.`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">watch</span>(<span class="function">() =&gt;</span> <span class="title function_">getter</span>(<span class="variable language_">this</span>.<span class="property">state</span>, <span class="variable language_">this</span>.<span class="property">getters</span>), cb, <span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;, options))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>watch</code>çš„å®ç°ä¾èµ–äº†<code>Vue3</code>çš„<code>watch</code>APIï¼Œåšäº†ä¸ªç®€å•çš„å…¥å‚åˆ¤æ–­ï¼Œæ¥å¯¹çŠ¶æ€è¿›è¡Œç›‘å¬ä»¥åŠæ‰§è¡Œä¼ å…¥å›è°ƒï¼Œ<code>options</code>å’Œ<code>Vue3</code>çš„<code>watch</code>é…ç½®ä¸€æ ·</p>
<h2 id="replaceState"><a href="#replaceState" class="headerlink" title="replaceState"></a><code>replaceState</code></h2><p>è¿™ä¸ªAPIå®˜æ–¹ç»™çš„ä¿¡æ¯å¤ªå°‘ï¼Œå°±ä¸€å¥</p>
<blockquote>
<p>æ›¿æ¢ store çš„æ ¹çŠ¶æ€ï¼Œä»…ç”¨çŠ¶æ€åˆå¹¶æˆ–æ—¶å…‰æ—…è¡Œè°ƒè¯•ã€‚</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Store</span> &#123;</span><br><span class="line">  <span class="title function_">replaceState</span> (state) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">_withCommit</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_state</span>.<span class="property">data</span> = state</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®ç°éå¸¸çš„ç®€å•ï¼Œå°±æ˜¯åŒ…åœ¨<code>_withCommit</code>ä¸­æ‰§è¡Œï¼Œæ›¿æ¢<code>state</code>è€Œå·²</p>
<p>ä¸€èˆ¬ä¸ºäº†åœ¨åˆ·æ–°æ—¶æ¢å¤çŠ¶æ€ä½¿ç”¨ï¼Œåœ¨<code>beforeunload</code>äº‹ä»¶ä¸­æŠŠçŠ¶æ€åºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²(<code>JSON.stringify</code>)å­˜å…¥<code>localStorage</code>ä¸­</p>
<p>ç„¶ååœ¨åŠ è½½ä¹‹ååˆ¤æ–­<code>localStorage</code>æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨å°±ä½¿ç”¨è¿™ä¸ªå‡½æ•°æ¥æ›¿æ¢çŠ¶æ€ã€‚</p>
<p>ä¸ªäººè§‰å¾—å¾ˆå°‘ä¼šä½¿ç”¨åˆ°è¿™ä¸ª<code>API</code>â€¦</p>
<p>å› ä¸ºå¦‚æœæ˜¯ä¸Šé¢çš„æƒ…å†µï¼Œä¸ºä»€ä¹ˆä¸åœ¨åˆ›å»º<code>store</code>ä¹‹å‰å°±æ„å»ºä¼ å…¥<code>createStore</code>çš„å‚æ•°å‘¢ï¼Ÿ</p>
<h2 id="registerModule"><a href="#registerModule" class="headerlink" title="registerModule"></a><code>registerModule</code></h2><p>æ³¨å†Œä¸€ä¸ªåŠ¨æ€æ¨¡å—</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Store</span> &#123;</span><br><span class="line">  <span class="title function_">registerModule</span> (path, rawModule, options = &#123;&#125;) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> path === <span class="string">&#x27;string&#x27;</span>) path = [path]</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="title function_">assert</span>(<span class="title class_">Array</span>.<span class="title function_">isArray</span>(path), <span class="string">`module path must be a string or an Array.`</span>)</span><br><span class="line">      <span class="title function_">assert</span>(path.<span class="property">length</span> &gt; <span class="number">0</span>, <span class="string">&#x27;cannot register the root module by using registerModule.&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_modules</span>.<span class="title function_">register</span>(path, rawModule)</span><br><span class="line">    <span class="title function_">installModule</span>(<span class="variable language_">this</span>, <span class="variable language_">this</span>.<span class="property">state</span>, path, <span class="variable language_">this</span>.<span class="property">_modules</span>.<span class="title function_">get</span>(path), options.<span class="property">preserveState</span>)</span><br><span class="line">    <span class="comment">// reset store to update getters...</span></span><br><span class="line">    <span class="title function_">resetStoreState</span>(<span class="variable language_">this</span>, <span class="variable language_">this</span>.<span class="property">state</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œæ³¨å†Œçš„é€»è¾‘æ˜¯ç”±<code>_modules.register</code>å®ç°ï¼Œæ³¨å†Œå®Œä¹‹åé€šè¿‡<code>installModule</code>å®‰è£…å¯¹åº”çš„<code>module</code></p>
<p>ç„¶åæ‰§è¡Œ<code>resetStoreState</code>æ¥é‡ç½®<code>store</code>æ¥æ›´æ–°<code>getters</code></p>
<p>åœ¨<code>Vuex</code>ä¸­ï¼Œåœ¨åˆå§‹åŒ–è®¾ç½®çš„æ¨¡å—ï¼Œå¯ä»¥ç†è§£ä¸ºé™æ€æ¨¡å—ï¼Œè¿™ç§æ¨¡å—æ— æ³•åˆ é™¤</p>
<p>åœ¨è¿è¡Œè¿‡ç¨‹ä¸­å¯ä»¥åŠ¨æ€çš„æ³¨å…¥ä¸€ä¸ªæ¨¡å—ï¼Œè¿™ç§æ¨¡å—å¯ä»¥ç†è§£ä¸ºåŠ¨æ€æ¨¡å—ï¼ŒåŠ¨æ€æ¨¡å—æ”¯æŒåˆ é™¤</p>
<p>è¿™ä¸¤è€…åº•å±‚å®ç°å°±æ˜¯ç”¨ä¸€ä¸ª<code>runtime</code>æ¥åˆ¤æ–­ï¼Œ<code>runtime</code>ä¸º<code>false</code>è¡¨ç¤ºé™æ€çš„æ¨¡å—ï¼Œåä¹‹ä¸ºåŠ¨æ€æ¨¡å—ï¼ˆè¿™ä¸ªä¹‹åä¼šå†™ï¼‰</p>
<p>è€Œä¸”é€šè¿‡å…¥å‚å¯ä»¥çœ‹å‡ºï¼Œæ³¨å†Œä¸€ä¸ªæ¨¡å—ï¼Œæ˜¯ä¼ å…¥ä¸€ä¸ª<code>path</code>æ•°ç»„çš„ï¼Œæ¯”å¦‚ç°åœ¨æœ‰å¦‚ä¸‹<code>store</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = <span class="title function_">createStore</span>(&#123;</span><br><span class="line">  <span class="attr">state</span>: &#123;&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨æƒ³åœ¨æ ¹ä¸‹é¢æ³¨å†Œä¸€ä¸ªåä¸º<code>m1</code>çš„æ¨¡å—ï¼Œé‚£ä¹ˆåº”è¯¥æ‰§è¡Œ</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">store.<span class="title function_">registerModule</span>([<span class="string">&#x27;m1&#x27;</span>], &#123;  </span><br><span class="line">  <span class="attr">state</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">getters</span>: &#123;&#125;,</span><br><span class="line">  <span class="comment">// å…¶ä»–é…ç½®</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>ç„¶åæƒ³åœ¨<code>m1</code>ä¸‹é¢æ³¨å†Œä¸€ä¸ª<code>m2</code>æ¨¡å—</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">store.<span class="title function_">registerModule</span>([<span class="string">&#x27;m1&#x27;</span>, <span class="string">&#x27;m2&#x27;</span>], &#123;  </span><br><span class="line">  <span class="attr">state</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">getters</span>: &#123;&#125;,</span><br><span class="line">  <span class="comment">// å…¶ä»–é…ç½®</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="unregisterModule"><a href="#unregisterModule" class="headerlink" title="unregisterModule"></a><code>unregisterModule</code></h2><p>å¸è½½ä¸€ä¸ªåŠ¨æ€çš„æ¨¡å—ï¼Œå¯¹äºåˆå§‹åŒ–çš„æ¨¡å—ï¼Œæ˜¯æ— æ³•å¸è½½çš„</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Store</span> &#123;</span><br><span class="line">  <span class="title function_">unregisterModule</span> (path) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> path === <span class="string">&#x27;string&#x27;</span>) path = [path]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="title function_">assert</span>(<span class="title class_">Array</span>.<span class="title function_">isArray</span>(path), <span class="string">`module path must be a string or an Array.`</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_modules</span>.<span class="title function_">unregister</span>(path)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">_withCommit</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> parentState = <span class="title function_">getNestedState</span>(<span class="variable language_">this</span>.<span class="property">state</span>, path.<span class="title function_">slice</span>(<span class="number">0</span>, -<span class="number">1</span>))</span><br><span class="line">      <span class="keyword">delete</span> parentState[path[path.<span class="property">length</span> - <span class="number">1</span>]]</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="title function_">resetStore</span>(<span class="variable language_">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œå¸è½½çš„ä¸»è¦å®ç°ä¹Ÿæ˜¯<code>_modules.unregister</code></p>
<p>ç„¶åé€šè¿‡<code>getNestedState</code>æŸ¥æ‰¾å¯¹åº”çš„çˆ¶çŠ¶æ€ï¼Œç„¶åä½¿ç”¨<code>delete</code>æ“ä½œåˆ é™¤ã€‚</p>
<p>æœ€åé‡ç½®äº†<code>store</code>ï¼Œè¿™ä¸ª<code>resetStore</code>åŒ…æ‹¬äº†<code>resetStoreState</code>æ“ä½œï¼Œåé¢ä¼šå†™åˆ°</p>
<h2 id="hasModule"><a href="#hasModule" class="headerlink" title="hasModule"></a><code>hasModule</code></h2><p>åˆ¤æ–­æ¨¡å—åå­—æ˜¯å¦è¢«æ³¨å†Œäº†</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Store</span> &#123;</span><br><span class="line">  <span class="title function_">hasModule</span> (path) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> path === <span class="string">&#x27;string&#x27;</span>) path = [path]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="title function_">assert</span>(<span class="title class_">Array</span>.<span class="title function_">isArray</span>(path), <span class="string">`module path must be a string or an Array.`</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_modules</span>.<span class="title function_">isRegistered</span>(path)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°å®ç°ä¹Ÿæ˜¯ä¾èµ–<code>_modules.isRegistered</code>ï¼Œåšäº†ç®€å•çš„åˆ¤æ–­</p>
<h1 id="å†…éƒ¨å‡½æ•°"><a href="#å†…éƒ¨å‡½æ•°" class="headerlink" title="å†…éƒ¨å‡½æ•°"></a>å†…éƒ¨å‡½æ•°</h1><h2 id="installModule"><a href="#installModule" class="headerlink" title="installModule"></a><code>installModule</code></h2><p>å®‰è£…æ¨¡å—ï¼Œé€’å½’çš„å®‰è£…å®ƒçš„å­æ¨¡å—ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">installModule</span> (<span class="params">store, rootState, path, <span class="variable language_">module</span>, hot</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> isRoot = !path.<span class="property">length</span></span><br><span class="line">  <span class="keyword">const</span> namespace = store.<span class="property">_modules</span>.<span class="title function_">getNamespace</span>(path)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// register in namespace map</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">module</span>.<span class="property">namespaced</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (store.<span class="property">_modulesNamespaceMap</span>[namespace] &amp;&amp; __DEV__) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`[vuex] duplicate namespace <span class="subst">$&#123;namespace&#125;</span> for the namespaced module <span class="subst">$&#123;path.join(<span class="string">&#x27;/&#x27;</span>)&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    store.<span class="property">_modulesNamespaceMap</span>[namespace] = <span class="variable language_">module</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// set state</span></span><br><span class="line">  <span class="keyword">if</span> (!isRoot &amp;&amp; !hot) &#123;</span><br><span class="line">    <span class="keyword">const</span> parentState = <span class="title function_">getNestedState</span>(rootState, path.<span class="title function_">slice</span>(<span class="number">0</span>, -<span class="number">1</span>))</span><br><span class="line">    <span class="keyword">const</span> moduleName = path[path.<span class="property">length</span> - <span class="number">1</span>]</span><br><span class="line">    store.<span class="title function_">_withCommit</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        <span class="keyword">if</span> (moduleName <span class="keyword">in</span> parentState) &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">warn</span>(</span><br><span class="line">            <span class="string">`[vuex] state field &quot;<span class="subst">$&#123;moduleName&#125;</span>&quot; was overridden by a module with the same name at &quot;<span class="subst">$&#123;path.join(<span class="string">&#x27;.&#x27;</span>)&#125;</span>&quot;`</span></span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      parentState[moduleName] = <span class="variable language_">module</span>.<span class="property">state</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> local = <span class="variable language_">module</span>.<span class="property">context</span> = <span class="title function_">makeLocalContext</span>(store, namespace, path)</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">module</span>.<span class="title function_">forEachMutation</span>(<span class="function">(<span class="params">mutation, key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> namespacedType = namespace + key</span><br><span class="line">    <span class="title function_">registerMutation</span>(store, namespacedType, mutation, local)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">module</span>.<span class="title function_">forEachAction</span>(<span class="function">(<span class="params">action, key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> type = action.<span class="property">root</span> ? key : namespace + key</span><br><span class="line">    <span class="keyword">const</span> handler = action.<span class="property">handler</span> || action</span><br><span class="line">    <span class="title function_">registerAction</span>(store, type, handler, local)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">module</span>.<span class="title function_">forEachGetter</span>(<span class="function">(<span class="params">getter, key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> namespacedType = namespace + key</span><br><span class="line">    <span class="title function_">registerGetter</span>(store, namespacedType, getter, local)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">module</span>.<span class="title function_">forEachChild</span>(<span class="function">(<span class="params">child, key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">installModule</span>(store, rootState, path.<span class="title function_">concat</span>(key), child, hot)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨å‰é¢<code>constructor</code>ä¸­æ‰§è¡Œäº†<code>installModule(this, state, [], this._modules.root)</code>æ¥å®‰è£…æ¨¡å—</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> isRoot = !path.<span class="property">length</span></span><br><span class="line"><span class="keyword">const</span> namespace = store.<span class="property">_modules</span>.<span class="title function_">getNamespace</span>(path)</span><br></pre></td></tr></table></figure>

<p>å…ˆåˆ¤æ–­äº†æ˜¯å¦ä¸ºæ ¹æ¨¡å—ï¼ˆ<code>isRoot</code>ï¼‰ï¼Œä»¥åŠè·å–è¿™ä¸ªæ¨¡å—çš„å‘½åç©ºé—´<code>namespace</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// register in namespace map</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable language_">module</span>.<span class="property">namespaced</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (store.<span class="property">_modulesNamespaceMap</span>[namespace] &amp;&amp; __DEV__) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`[vuex] duplicate namespace <span class="subst">$&#123;namespace&#125;</span> for the namespaced module <span class="subst">$&#123;path.join(<span class="string">&#x27;/&#x27;</span>)&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  store.<span class="property">_modulesNamespaceMap</span>[namespace] = <span class="variable language_">module</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæ¨¡å—æ˜¯å¸¦å‘½åç©ºé—´çš„ï¼ˆæ³¨æ„è¿™é‡Œæ˜¯ä¸¤ä¸ªä¸œè¥¿<code>namespaced</code>å’Œ<code>namespace</code>ï¼‰</p>
<p>é‚£ä¹ˆä¼šæ³¨å†Œåˆ°<code>_modulesNamespaceMap</code>è¿™ä¸ªå¯¹è±¡ä¸­ï¼Œæ¯”å¦‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = <span class="title function_">createStore</span>(&#123;</span><br><span class="line">  <span class="attr">modules</span>: &#123;</span><br><span class="line">    <span class="attr">m1</span>: &#123;</span><br><span class="line">      <span class="attr">namespaced</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆæ­¤æ—¶<code>m1</code>å­æ¨¡å—åœ¨<code>_modulesNamespaceMap</code>ä¸­å¯¹åº”<code>m1/</code>å±æ€§</p>
<p><img data-src="https://i.loli.net/2020/10/22/f6JDmGWx1L3lH2Q.png"></p>
<p>æ¥ç€æ˜¯ä¸€æ®µåˆ¤æ–­</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// set state</span></span><br><span class="line"><span class="keyword">if</span> (!isRoot &amp;&amp; !hot) &#123;</span><br><span class="line">  <span class="keyword">const</span> parentState = <span class="title function_">getNestedState</span>(rootState, path.<span class="title function_">slice</span>(<span class="number">0</span>, -<span class="number">1</span>))</span><br><span class="line">  <span class="keyword">const</span> moduleName = path[path.<span class="property">length</span> - <span class="number">1</span>]</span><br><span class="line">  store.<span class="title function_">_withCommit</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="keyword">if</span> (moduleName <span class="keyword">in</span> parentState) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">warn</span>(</span><br><span class="line">          <span class="string">`[vuex] state field &quot;<span class="subst">$&#123;moduleName&#125;</span>&quot; was overridden by a module with the same name at &quot;<span class="subst">$&#123;path.join(<span class="string">&#x27;.&#x27;</span>)&#125;</span>&quot;`</span></span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    parentState[moduleName] = <span class="variable language_">module</span>.<span class="property">state</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæˆ‘ä»¬å…ˆç®€å•è®¤ä¸º<code>hot</code>å°±æ˜¯<code>false</code>ï¼Œä¹Ÿå°±æ˜¯åœ¨<strong>ä¸æ˜¯æ ¹æ¨¡å—</strong>çš„æƒ…å†µä¸‹æ‰ä¼šè®¾ç½®çŠ¶æ€</p>
<p>é‚£ä¸ºå•¥æ ¹ä¸è®¾ç½®çŠ¶æ€å‘¢ï¼Œå…¶å®æ ¹çš„çŠ¶æ€åœ¨<code>constructor</code>ä¸­ç”±<code>ModuleColleton</code>å¯¹è±¡æ¥è®¾ç½®äº†</p>
<p>åœ¨<code>constructor</code>ä¸­<code>this._modules = new ModuleCollection(options)</code>åˆå§‹åŒ–äº†æ ¹<code>root</code>çš„çŠ¶æ€</p>
<p><code>ModuleCollection</code>è¿™ä¸ªä¹‹åä¼šå†™ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°<code>if</code>å†…çš„å®ç°æ˜¯å…ˆé€šè¿‡<code>getNestedState</code>æ‰¾åˆ°ä»–çš„çˆ¶çŠ¶æ€å¯¹è±¡</p>
<p>ç„¶åè·å–æ¨¡å—çš„åå­—<code>moduleName</code>ï¼Œåšäº†ä¸ªåˆ¤æ–­ï¼Œé˜²æ­¢é‡åæ¨¡å—çš„å‡ºç°ï¼Œ</p>
<p>æœ€åå°±åœ¨çˆ¶çŠ¶æ€ä¸‹æŒ‚è½½å¯¹åº”å­æ¨¡å—çš„çŠ¶æ€<code>parentState[moduleName] = module.state</code>ï¼Œæ¯”å¦‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = <span class="title function_">createStore</span>(&#123;</span><br><span class="line">  <span class="attr">state</span>: &#123;</span><br><span class="line">    <span class="attr">val</span>: <span class="number">1</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">modules</span>: &#123;</span><br><span class="line">    <span class="attr">m1</span>: &#123;</span><br><span class="line">      <span class="attr">state</span>: &#123;</span><br><span class="line">        <span class="attr">val</span>: <span class="number">2</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œè¿™ä¸ªå‡½æ•°ä¹‹åï¼Œ<code>store.state</code>å°±å˜æˆäº†</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">store.<span class="property">state</span> = &#123;</span><br><span class="line">  <span class="attr">val</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">m1</span>: &#123;</span><br><span class="line">    <span class="attr">val</span>: <span class="number">2</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ç€åˆ›å»ºäº†å½“å‰æ¨¡å—çš„ä¸Šä¸‹æ–‡å‚æ•°ï¼Œç”¨äºä¹‹åæ³¨å†Œ<code>getters</code>ï¼Œ<code>mutations</code>å’Œ<code>actions</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> local = <span class="variable language_">module</span>.<span class="property">context</span> = <span class="title function_">makeLocalContext</span>(store, namespace, path)</span><br></pre></td></tr></table></figure>

<p>æ¥ç€åˆ†åˆ«éå†äº†å½“å‰æ¨¡å—çš„<code>getters</code>ï¼Œ<code>mutations</code>å’Œ<code>actions</code></p>
<p>è°ƒç”¨<code>registerGetter</code>ï¼Œ<code>registerMutation</code>å’Œ<code>registerAction</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="title function_">forEachMutation</span>(<span class="function">(<span class="params">mutation, key</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> namespacedType = namespace + key</span><br><span class="line">  <span class="title function_">registerMutation</span>(store, namespacedType, mutation, local)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="title function_">forEachAction</span>(<span class="function">(<span class="params">action, key</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// ç›´æ¥dispatchæ ¹çš„actionï¼Œè¿™é‡Œå¯ä»¥çœ‹æ–‡æ¡£</span></span><br><span class="line">  <span class="keyword">const</span> type = action.<span class="property">root</span> ? key : namespace + key</span><br><span class="line">  <span class="keyword">const</span> handler = action.<span class="property">handler</span> || action</span><br><span class="line">  <span class="title function_">registerAction</span>(store, type, handler, local)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="title function_">forEachGetter</span>(<span class="function">(<span class="params">getter, key</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> namespacedType = namespace + key</span><br><span class="line">  <span class="title function_">registerGetter</span>(store, namespacedType, getter, local)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>æœ€åéå†æ¨¡å—çš„<code>modules</code>ï¼Œé€’å½’çš„å¤„ç†è¿™ä¸ªè¿‡ç¨‹</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="title function_">forEachChild</span>(<span class="function">(<span class="params">child, key</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">installModule</span>(store, rootState, path.<span class="title function_">concat</span>(key), child, hot)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå¯ä»¥æ€»ç»“å‡ºè¿™ä¸ªå‡½æ•°çš„ä½œç”¨ï¼Œä¹Ÿå°±æ˜¯æŠŠæ¯ä¸ªæ¨¡å—çš„<code>state</code>çš„çŠ¶æ€èšåˆåˆ°æ ¹æ¨¡å—çš„çš„<code>state</code>ä¸Šï¼ˆä¹Ÿå°±æ˜¯<code>this._modules.root.state</code>ï¼Œåœ¨æ„é€ å™¨ä¸­çš„è¯­å¥ï¼Œä¼ å…¥äº†è¿™ä¸ªå‡½æ•°ï¼‰</p>
<p>æ³¨å†Œ<code>getters</code>ï¼Œ<code>mutations</code>ï¼Œ<code>actions</code></p>
<p>è¿™é‡Œæ²¡æœ‰å‘ç°å’Œå“åº”å¼ç›¸å…³çš„è¯­å¥ï¼Œå› ä¸ºå“åº”å¼çš„å¤„ç†åœ¨å¦ä¸€ä¸ªå‡½æ•°</p>
<p>æ³¨æ„ï¼Œåœ¨<code>Vuex</code>ä¸­ï¼Œå¾ˆå¤šæ—¶å€™ç”¨ä¸€ä¸ª<code>path</code>æ•°ç»„æ¥è¡¨ç¤ºå½“å‰æ¨¡å—çš„<code>state</code></p>
<p>åœ¨é€’å½’æ³¨å†Œå­æ¨¡å—æ‰§è¡Œ<code>installModule</code>æ—¶ï¼Œä¼ å…¥<code>path.concat(key)</code>ï¼Œæ¯”å¦‚</p>
<p>å¦‚æœæ­¤æ—¶æ¨¡å—ä¸º<code>root</code>ï¼Œé‚£ä¹ˆæ­¤æ—¶<code>path</code>æ•°ç»„ä¸º<code>[]</code></p>
<p>å¦‚æœæ­¤æ—¶<code>root</code>åŒ…å«äº†ä¸€ä¸ªåå­—ä¸º<code>m1</code>çš„æ¨¡å—ï¼Œé‚£ä¹ˆéå†åˆ°<code>m1</code>æ¨¡å—æ—¶ï¼Œ<code>path</code>æ•°ç»„ä¸º<code>[&#39;m1&#39;]</code></p>
<h2 id="resetStoreState"><a href="#resetStoreState" class="headerlink" title="resetStoreState"></a><code>resetStoreState</code></h2><p>é‡ç½®<code>store</code>çš„çŠ¶æ€ï¼Œåœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œä¼šæŠŠ<code>_state</code>å˜æˆå“åº”å¼å¯¹è±¡</p>
<p>å¹¶ä¸”å¯¹<code>wrappedGetters</code>ä¸­çš„<code>getter</code>ä¹Ÿè½¬ä¸º<code>computed</code>è®¡ç®—å±æ€§</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">resetStoreState</span> (<span class="params">store, state, hot</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> oldState = store.<span class="property">_state</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// bind store public getters</span></span><br><span class="line">  store.<span class="property">getters</span> = &#123;&#125;</span><br><span class="line">  <span class="comment">// reset local getters cache</span></span><br><span class="line">  store.<span class="property">_makeLocalGettersCache</span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line">  <span class="keyword">const</span> wrappedGetters = store.<span class="property">_wrappedGetters</span></span><br><span class="line">  <span class="keyword">const</span> computedObj = &#123;&#125;</span><br><span class="line">  <span class="title function_">forEachValue</span>(wrappedGetters, <span class="function">(<span class="params">fn, key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// use computed to leverage its lazy-caching mechanism</span></span><br><span class="line">    <span class="comment">// direct inline function use will lead to closure preserving oldVm.</span></span><br><span class="line">    <span class="comment">// using partial to return function with only arguments preserved in closure environment.</span></span><br><span class="line">    computedObj[key] = <span class="title function_">partial</span>(fn, store)</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(store.<span class="property">getters</span>, key, &#123;</span><br><span class="line">      <span class="attr">get</span>: <span class="function">() =&gt;</span> <span class="title function_">computed</span>(<span class="function">() =&gt;</span> computedObj[key]()).<span class="property">value</span>,</span><br><span class="line">      <span class="attr">enumerable</span>: <span class="literal">true</span> <span class="comment">// for local getters</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  store.<span class="property">_state</span> = <span class="title function_">reactive</span>(&#123;</span><br><span class="line">    <span class="attr">data</span>: state</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// enable strict mode for new state</span></span><br><span class="line">  <span class="keyword">if</span> (store.<span class="property">strict</span>) &#123;</span><br><span class="line">    <span class="title function_">enableStrictMode</span>(store)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (oldState) &#123;</span><br><span class="line">    <span class="keyword">if</span> (hot) &#123;</span><br><span class="line">      <span class="comment">// dispatch changes in all subscribed watchers</span></span><br><span class="line">      <span class="comment">// to force getter re-evaluation for hot reloading.</span></span><br><span class="line">      store.<span class="title function_">_withCommit</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        oldState.<span class="property">data</span> = <span class="literal">null</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…ˆæ˜¯åœ¨<code>store</code>ä¸Šåˆå§‹åŒ–<code>getters</code>å’Œ<code>_makeLocalGettersCache</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bind store public getters</span></span><br><span class="line">store.<span class="property">getters</span> = &#123;&#125;</span><br><span class="line"><span class="comment">// reset local getters cache</span></span><br><span class="line">store.<span class="property">_makeLocalGettersCache</span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br></pre></td></tr></table></figure>

<p>ç„¶åéå†äº†åœ¨<code>installModule</code>ä¸­æ³¨å†Œçš„æ‰€æœ‰çš„<code>getter</code>ï¼Œä¹Ÿå°±æ˜¯<code>_wrappedGetters</code>ä¸Šçš„æ‰€æœ‰å±æ€§</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">forEachValue</span>(wrappedGetters, <span class="function">(<span class="params">fn, key</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// use computed to leverage its lazy-caching mechanism</span></span><br><span class="line">  <span class="comment">// direct inline function use will lead to closure preserving oldVm.</span></span><br><span class="line">  <span class="comment">// using partial to return function with only arguments preserved in closure environment.</span></span><br><span class="line">  computedObj[key] = <span class="title function_">partial</span>(fn, store)</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(store.<span class="property">getters</span>, key, &#123;</span><br><span class="line">    <span class="attr">get</span>: <span class="function">() =&gt;</span> <span class="title function_">computed</span>(<span class="function">() =&gt;</span> computedObj[key]()).<span class="property">value</span>,</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span> <span class="comment">// for local getters</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„è¿™é‡Œåˆ©ç”¨<code>Object.defineProperty</code>å»¶è¿Ÿäº†è°ƒç”¨<code>computed</code>åˆ›å»ºä¸€ä¸ªè®¡ç®—å±æ€§</p>
<p>ç„¶åå°±æ˜¯å¯¹<code>state</code>å“åº”å¼åŒ–ï¼Œä½¿ç”¨<code>Vue3</code>çš„<code>reactive</code>APIæ¥åˆ›å»ºä¸€ä¸ªå“åº”å¼å¯¹è±¡</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">store.<span class="property">_state</span> = <span class="title function_">reactive</span>(&#123;</span><br><span class="line">  <span class="attr">data</span>: state</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>æ¥ç€æ ¹æ®<code>strict</code>å±æ€§åˆ¤æ–­æ˜¯å¦è¦å¼€å¯ä¸¥æ ¼æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯æ˜¯å¦æ‰§è¡Œ<code>enableStrictMode</code>å‡½æ•°</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// enable strict mode for new state</span></span><br><span class="line"><span class="keyword">if</span> (store.<span class="property">strict</span>) &#123;</span><br><span class="line">  <span class="title function_">enableStrictMode</span>(store)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åä¸€ä¸ªåˆ¤æ–­å’Œçƒ­é‡è½½æœ‰å…³ï¼Œå¿½ç•¥ã€‚</p>
<p>æ€»ç»“æ¥è¯´è¿™ä¸ªå‡½æ•°å°±æ˜¯ç»™å·²ç»èšåˆçš„<code>this._modules.root.state</code>ï¼ˆåœ¨æ„é€ å‡½æ•°ä¸­ï¼Œä¼ å…¥äº†è¿™ä¸ªå‡½æ•°ï¼‰å¯¹è±¡è®¾ä¸ºå“åº”å¼</p>
<p>å¹¶æŠŠ<code>_wrappedGetters</code>ä¸Šçš„<code>getter</code>è®¾ä¸ºè®¡ç®—å±æ€§ï¼ŒæŒ‚è½½åˆ°<code>store.getters</code>ä¸Š</p>
<h2 id="resetStore"><a href="#resetStore" class="headerlink" title="resetStore"></a><code>resetStore</code></h2><p>é‡ç½®ä¸€ä¸ª<code>store</code>ï¼Œæ¸…é™¤æ³¨å†Œçš„æ‰€æœ‰<code>actions</code>ï¼Œ<code>mutations</code>ï¼Œ<code>getters</code>å’Œæ¨¡å—å¯¹è±¡</p>
<p>ç„¶åæ ¹æ®åŸæ¥çš„<code>state</code>é‡æ–°æ‰§è¡Œ<code>installModule</code>å’Œ<code>resetStoreState</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">resetStore</span> (<span class="params">store, hot</span>) &#123;</span><br><span class="line">  store.<span class="property">_actions</span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line">  store.<span class="property">_mutations</span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line">  store.<span class="property">_wrappedGetters</span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line">  store.<span class="property">_modulesNamespaceMap</span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line">  <span class="comment">// è·å–åŸæ¥çš„çŠ¶æ€</span></span><br><span class="line">  <span class="keyword">const</span> state = store.<span class="property">state</span></span><br><span class="line">  <span class="comment">// init all modules</span></span><br><span class="line">  <span class="title function_">installModule</span>(store, state, [], store.<span class="property">_modules</span>.<span class="property">root</span>, <span class="literal">true</span>)</span><br><span class="line">  <span class="comment">// reset state</span></span><br><span class="line">  <span class="title function_">resetStoreState</span>(store, state, hot)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="makeLocalContext"><a href="#makeLocalContext" class="headerlink" title="makeLocalContext"></a><code>makeLocalContext</code></h2><p>å¯ä»¥ç†è§£ä¸ºä¸ºæ¯ä¸€ä¸ªæ¨¡å—åˆ›å»ºä¸€ä¸ªä¸Šä¸‹æ–‡ï¼ŒåŒ…æ‹¬è¿™ä¸ªæ¨¡å—è‡ªå·±çš„<code>dispatch</code>å’Œ<code>commit</code>å‡½æ•°</p>
<p>ä»¥åŠæŒ‚è½½<code>getters</code>å’Œ<code>state</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">makeLocalContext</span> (<span class="params">store, namespace, path</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> noNamespace = namespace === <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> local = &#123;</span><br><span class="line">    <span class="attr">dispatch</span>: noNamespace ? store.<span class="property">dispatch</span> : <span class="function">(<span class="params">_type, _payload, _options</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> args = <span class="title function_">unifyObjectStyle</span>(_type, _payload, _options)</span><br><span class="line">      <span class="keyword">const</span> &#123; payload, options &#125; = args</span><br><span class="line">      <span class="keyword">let</span> &#123; type &#125; = args</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!options || !options.<span class="property">root</span>) &#123;</span><br><span class="line">        type = namespace + type</span><br><span class="line">        <span class="keyword">if</span> (__DEV__ &amp;&amp; !store.<span class="property">_actions</span>[type]) &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`[vuex] unknown local action type: <span class="subst">$&#123;args.type&#125;</span>, global type: <span class="subst">$&#123;type&#125;</span>`</span>)</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> store.<span class="title function_">dispatch</span>(type, payload)</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="attr">commit</span>: noNamespace ? store.<span class="property">commit</span> : <span class="function">(<span class="params">_type, _payload, _options</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> args = <span class="title function_">unifyObjectStyle</span>(_type, _payload, _options)</span><br><span class="line">      <span class="keyword">const</span> &#123; payload, options &#125; = args</span><br><span class="line">      <span class="keyword">let</span> &#123; type &#125; = args</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!options || !options.<span class="property">root</span>) &#123;</span><br><span class="line">        type = namespace + type</span><br><span class="line">        <span class="keyword">if</span> (__DEV__ &amp;&amp; !store.<span class="property">_mutations</span>[type]) &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`[vuex] unknown local mutation type: <span class="subst">$&#123;args.type&#125;</span>, global type: <span class="subst">$&#123;type&#125;</span>`</span>)</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      store.<span class="title function_">commit</span>(type, payload, options)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getters and state object must be gotten lazily</span></span><br><span class="line">  <span class="comment">// because they will be changed by state update</span></span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">defineProperties</span>(local, &#123;</span><br><span class="line">    <span class="attr">getters</span>: &#123;</span><br><span class="line">      <span class="attr">get</span>: noNamespace</span><br><span class="line">        ? <span class="function">() =&gt;</span> store.<span class="property">getters</span></span><br><span class="line">        : <span class="function">() =&gt;</span> <span class="title function_">makeLocalGetters</span>(store, namespace)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">state</span>: &#123;</span><br><span class="line">      <span class="attr">get</span>: <span class="function">() =&gt;</span> <span class="title function_">getNestedState</span>(store.<span class="property">state</span>, path)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> local</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ ¹æ®<code>Vuex</code>çš„æ–‡æ¡£ï¼Œå¦‚æœä¸€ä¸ªæ¨¡å—æ²¡æœ‰è®¾ç½®å‘½åç©ºé—´<code>namespaced</code>çš„è¯ï¼Œ</p>
<p>é‚£ä¹ˆä»–çš„<code>action</code>å’Œ<code>mutation</code>éƒ½ä¼šç›´æ¥æ³¨å†Œåˆ°æ ¹ä¸Š</p>
<p>ä¹Ÿå°±æ˜¯ä¸åŒçš„æ¨¡å—å¯ä»¥å¯¹åŒä¸€ä¸ªåå­—æ³¨å†Œ<code>action</code>æˆ–è€…<code>mutation</code></p>
<p>ä¹Ÿå°±æœ‰äº†ä¹‹å‰è¯´çš„<code>_mutations</code>å¯¹è±¡æ¯ä¸ªå±æ€§å¯¹åº”çš„ä¸æ˜¯å•ä¸ªå‡½æ•°ï¼Œè€Œæ˜¯ä¸€ä¸ªå‡½æ•°æ•°ç»„ï¼Œæ¯”å¦‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = <span class="title function_">createStore</span>(&#123;</span><br><span class="line">  <span class="attr">mutations</span>: &#123;</span><br><span class="line">    <span class="title function_">mutation1</span>(<span class="params"></span>) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">modules</span>: &#123;</span><br><span class="line">    <span class="attr">m1</span>: &#123;</span><br><span class="line">      <span class="attr">mutations</span>: &#123;</span><br><span class="line">        <span class="title function_">mutation1</span>(<span class="params"></span>) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆæ­¤æ—¶<code>mutation1</code>å°±ä¼šæœ‰ä¸¤ä¸ªå‡½æ•°ï¼Œå½“<code>commit</code>çš„æ—¶å€™ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°éƒ½ä¼šæ‰§è¡Œï¼ˆ<code>actions</code>åŒç†ï¼‰</p>
<p><img data-src="https://i.loli.net/2020/10/22/zsdokDE983AK7C1.png"></p>
<p>è€Œå¦‚æœæ¨¡å—<code>m1</code>è®¾ç½®<code>namespaced</code>ä¸º<code>true</code>çš„è¯ï¼Œé‚£ä¹ˆ<code>m1</code>çš„<code>mutation1</code>å°±ä¼šå¸¦ä¸Šå‘½åç©ºé—´</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = <span class="title function_">createStore</span>(&#123;</span><br><span class="line">  <span class="attr">mutations</span>: &#123;</span><br><span class="line">    <span class="title function_">mutation1</span>(<span class="params"></span>) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">modules</span>: &#123;</span><br><span class="line">    <span class="attr">m1</span>: &#123;</span><br><span class="line">      <span class="attr">mutations</span>: &#123;</span><br><span class="line">        <span class="title function_">mutation1</span>(<span class="params"></span>) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆæ­¤æ—¶<code>m1</code>çš„<code>mutation1</code>åœ¨æ ¹ä¸­å°±ä¼šå¸¦ä¸Š<code>m1/</code>çš„å‰ç¼€</p>
<p><img data-src="https://i.loli.net/2020/10/22/6CpHULjgrhfnS1G.png"></p>
<p>å¯ä»¥ä»¥dispatchä¸ºä¾‹</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dispatch</span>: noNamespace ? store.<span class="property">dispatch</span> : <span class="function">(<span class="params">_type, _payload, _options</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> args = <span class="title function_">unifyObjectStyle</span>(_type, _payload, _options)</span><br><span class="line">  <span class="keyword">const</span> &#123; payload, options &#125; = args</span><br><span class="line">  <span class="keyword">let</span> &#123; type &#125; = args</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!options || !options.<span class="property">root</span>) &#123;</span><br><span class="line">    type = namespace + type</span><br><span class="line">    <span class="keyword">if</span> (__DEV__ &amp;&amp; !store.<span class="property">_actions</span>[type]) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`[vuex] unknown local action type: <span class="subst">$&#123;args.type&#125;</span>, global type: <span class="subst">$&#123;type&#125;</span>`</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> store.<span class="title function_">dispatch</span>(type, payload)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å­˜åœ¨å‘½åç©ºé—´çš„æƒ…å†µä¸‹ï¼Œå°±æ˜¯æŠŠå‘½åç©ºé—´æ·»åŠ åˆ°å¯¹åº”çš„<code>action</code>åå­—å‰ï¼Œç„¶åæ‰§è¡Œ<code>dispatch</code>ï¼Œè¿™æ ·å°±èƒ½å–åˆ°å¯¹åº”çš„<code>action</code></p>
<p>è€Œåœ¨å½“å‰çš„æ¨¡å—ä¸‹ï¼Œå¹¶ä¸éœ€è¦çŸ¥é“çœŸæ­£çš„<code>action</code>åå­—ï¼Œå› ä¸ºè¿™é‡Œå·²ç»æ›¿æˆ‘ä»¬å¤„ç†äº†</p>
<p>æ¯”å¦‚æ¨¡å—<code>m1</code>çš„<code>ac2</code>åˆ†å‘äº†<code>ac1</code>ï¼Œå¦‚ä¸‹</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = <span class="title function_">createStore</span>(&#123;</span><br><span class="line">  <span class="attr">actions</span>: &#123;</span><br><span class="line">    <span class="title function_">ac1</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;root ac1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">modules</span>: &#123;</span><br><span class="line">    <span class="attr">m1</span>: &#123;</span><br><span class="line">      <span class="attr">namespaced</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">actions</span>: &#123;</span><br><span class="line">        <span class="title function_">ac1</span>(<span class="params"></span>) &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;m1 ac1&quot;</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">ac2</span>(<span class="params">&#123;dispatch&#125;</span>) &#123;</span><br><span class="line">          <span class="comment">// è¿™é‡Œçš„ac1åªä¼šæ˜¯æœ¬æ¨¡å—çš„ac1ï¼Œå‘½åç©ºé—´å·²ç»é€šè¿‡åŒ…è£…dispatchå‡½æ•°å¤„ç†äº†</span></span><br><span class="line">          <span class="title function_">dispatch</span>(<span class="string">&quot;ac1&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><img data-src="https://i.loli.net/2020/10/23/IZk3ovmrM7sBEQ8.png"></p>
<p>é™¤äº†åŒ…è£…äº†<code>dispatch</code>å’Œ<code>commit</code></p>
<p>å¦‚æœå­˜åœ¨å‘½åç©ºé—´ï¼Œä¹Ÿä¼šæ³¨å…¥ç›¸åº”çš„<code>getters</code>å’Œ<code>state</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperties</span>(local, &#123;</span><br><span class="line">  <span class="attr">getters</span>: &#123;</span><br><span class="line">    <span class="attr">get</span>: noNamespace</span><br><span class="line">      ? <span class="function">() =&gt;</span> store.<span class="property">getters</span></span><br><span class="line">      : <span class="function">() =&gt;</span> <span class="title function_">makeLocalGetters</span>(store, namespace)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">state</span>: &#123;</span><br><span class="line">    <span class="attr">get</span>: <span class="function">() =&gt;</span> <span class="title function_">getNestedState</span>(store.<span class="property">state</span>, path)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>å¦‚æœå­˜åœ¨å‘½åç©ºé—´ï¼Œé‚£ä¹ˆä¼šæ‰§è¡Œ<code>makeLocalGetters</code>ï¼Œæ ¹æ®å‘½åç©ºé—´æ¥æ‹¿åˆ°å¯¹åº”çš„<code>getters</code>ï¼Œ</p>
<p>è€Œæœ¬æ¨¡å—çš„<code>state</code>åªè¦é€šè¿‡<code>getNestedState</code>æ¥ä»æ ¹è·å–å¯¹åº”åµŒå¥—çš„<code>state</code>å³å¯</p>
<h2 id="makeLocalGetters"><a href="#makeLocalGetters" class="headerlink" title="makeLocalGetters"></a><code>makeLocalGetters</code></h2><p>é€šè¿‡å‘½åç©ºé—´æ¥è·å–ç›¸åº”æ¨¡å—çš„<code>getter</code>ï¼Œç„¶åå¯¹ç»“æœç¼“å­˜ï¼Œå‡å°‘è®¡ç®—ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">makeLocalGetters</span> (<span class="params">store, namespace</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!store.<span class="property">_makeLocalGettersCache</span>[namespace]) &#123;</span><br><span class="line">    <span class="keyword">const</span> gettersProxy = &#123;&#125;</span><br><span class="line">    <span class="keyword">const</span> splitPos = namespace.<span class="property">length</span></span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">keys</span>(store.<span class="property">getters</span>).<span class="title function_">forEach</span>(<span class="function"><span class="params">type</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// skip if the target getter is not match this namespace</span></span><br><span class="line">      <span class="keyword">if</span> (type.<span class="title function_">slice</span>(<span class="number">0</span>, splitPos) !== namespace) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// extract local getter type</span></span><br><span class="line">      <span class="keyword">const</span> localType = type.<span class="title function_">slice</span>(splitPos)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Add a port to the getters proxy.</span></span><br><span class="line">      <span class="comment">// Define as getter property because</span></span><br><span class="line">      <span class="comment">// we do not want to evaluate the getters in this time.</span></span><br><span class="line">      <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(gettersProxy, localType, &#123;</span><br><span class="line">        <span class="attr">get</span>: <span class="function">() =&gt;</span> store.<span class="property">getters</span>[type],</span><br><span class="line">        <span class="attr">enumerable</span>: <span class="literal">true</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    store.<span class="property">_makeLocalGettersCache</span>[namespace] = gettersProxy</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> store.<span class="property">_makeLocalGettersCache</span>[namespace]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…ˆåˆ¤æ–­<code>_makeLocalGettersCache</code>æ˜¯å¦å·²ç»ç¼“å­˜äº†ç»“æœï¼Œå¦‚æœç¼“å­˜äº†ï¼Œç›´æ¥è¿”å›</p>
<p>æ²¡æœ‰ç¼“å­˜çš„è¯ï¼Œä¼šæŠŠæ ¹çš„<code>getters</code>å¸¦ç›¸åº”å‘½åç©ºé—´çš„æå–å‡ºæ¥ï¼Œç„¶åç¼“å­˜ä¸‹æ¥å¹¶è¿”å›ã€‚</p>
<p>æ¯”å¦‚æ­¤æ—¶æ‰§è¡Œäº†<code>makeLocalGetters(store, &quot;m1/&quot;)</code></p>
<p>ä¹Ÿå°±æ˜¯è¦æ‰¾å‡º<code>m1</code>çš„<code>getter</code>ï¼Œå¯¹æ ¹<code>getters</code>ä¸­çš„æ¯ä¸ª<code>getter</code></p>
<p>æ‰§è¡Œ<code>slice(0, namespace.length)</code>æˆªå–<code>getter</code>åå­—çš„å‰é¢éƒ¨åˆ†å’Œ<code>namespace</code>æ¯”è¾ƒ</p>
<p>ç›¸ç­‰å°±åŠ å…¥ç»“æœé›†ï¼Œç„¶åç¼“å­˜è¿”å›ï¼Œè€Œä¸”è¦æ³¨æ„ï¼Œæ­¤æ—¶çš„<code>getter</code>å·²ç»ä¸å¸¦å‘½åç©ºé—´äº†</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä»å½“å‰çš„å‘½åç©ºé—´å¾€åæˆªå–</span></span><br><span class="line"><span class="keyword">const</span> localType = type.<span class="title function_">slice</span>(splitPos)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŒ‚è½½åˆ°ç»“æœé›†ä¸Š</span></span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(gettersProxy, localType, &#123;</span><br><span class="line">  <span class="attr">get</span>: <span class="function">() =&gt;</span> store.<span class="property">getters</span>[type],</span><br><span class="line">  <span class="attr">enumerable</span>: <span class="literal">true</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="registerGetter"><a href="#registerGetter" class="headerlink" title="registerGetter"></a><code>registerGetter</code></h2><p>æŠŠæ¨¡å—çš„<code>getter</code>æ³¨å†Œåˆ°<code>_wrappedGetters</code>ä¸Šï¼Œ</p>
<p>æ­¤æ—¶æ ¹æ®ä¼ å…¥çš„<code>local</code>ï¼ˆä¹Ÿå°±æ˜¯ä¹‹å‰é€šè¿‡<code>makeLocalContext</code>åˆ›å»ºçš„æœ¬æ¨¡å—çš„ä¸Šä¸‹æ–‡ï¼‰</p>
<p>åšäº†ä¸€ä¸ªå‡½æ•°çš„åŒ…è£…ï¼Œå»¶è¿Ÿæ‰§è¡Œ</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">registerGetter</span> (<span class="params">store, type, rawGetter, local</span>) &#123;</span><br><span class="line">  <span class="comment">// åˆ¤æ–­æ˜¯å¦å·²ç»å­˜åœ¨ç›¸åŒåå­—çš„getterï¼Œå­˜åœ¨å°±æŠ¥é”™è¿”å›</span></span><br><span class="line">  <span class="keyword">if</span> (store.<span class="property">_wrappedGetters</span>[type]) &#123;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`[vuex] duplicate getter key: <span class="subst">$&#123;type&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// åŒ…è£…getterï¼Œç»‘å®šä¸Šä¸‹æ–‡</span></span><br><span class="line">  store.<span class="property">_wrappedGetters</span>[type] = <span class="keyword">function</span> <span class="title function_">wrappedGetter</span> (<span class="params">store</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">rawGetter</span>(</span><br><span class="line">      local.<span class="property">state</span>, <span class="comment">// local state</span></span><br><span class="line">      local.<span class="property">getters</span>, <span class="comment">// local getters</span></span><br><span class="line">      store.<span class="property">state</span>, <span class="comment">// root state</span></span><br><span class="line">      store.<span class="property">getters</span> <span class="comment">// root getters</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="registerMutation"><a href="#registerMutation" class="headerlink" title="registerMutation"></a><code>registerMutation</code></h2><p>æŠŠæ¨¡å—çš„<code>mutation</code>æ³¨å†Œåˆ°<code>_mutations</code>ä¸Š</p>
<p>æ­¤æ—¶æ ¹æ®ä¼ å…¥çš„<code>local</code>ï¼ˆä¹Ÿå°±æ˜¯ä¹‹å‰é€šè¿‡<code>makeLocalContext</code>åˆ›å»ºçš„æœ¬æ¨¡å—çš„ä¸Šä¸‹æ–‡ï¼‰</p>
<p>åšäº†ä¸€ä¸ªå‡½æ•°çš„åŒ…è£…ï¼Œå»¶è¿Ÿæ‰§è¡Œ</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">registerMutation</span> (<span class="params">store, type, handler, local</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> entry = store.<span class="property">_mutations</span>[type] || (store.<span class="property">_mutations</span>[type] = [])</span><br><span class="line">  <span class="comment">// åŒ…è£…ï¼Œå»¶è¿Ÿæ‰§è¡Œï¼Œæ¨å…¥ç›¸åº”çš„mutationæ•°ç»„</span></span><br><span class="line">  entry.<span class="title function_">push</span>(<span class="keyword">function</span> <span class="title function_">wrappedMutationHandler</span> (<span class="params">payload</span>) &#123;</span><br><span class="line">    handler.<span class="title function_">call</span>(store, local.<span class="property">state</span>, payload)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="registerAction"><a href="#registerAction" class="headerlink" title="registerAction"></a><code>registerAction</code></h2><p>æŠŠæ¨¡å—çš„<code>action</code>æ³¨å†Œåˆ°<code>_actions</code>å±æ€§ä¸Š</p>
<p><code>action</code>çš„å­˜å‚¨æ–¹å¼å’Œ<code>mutation</code>ä¸€æ ·ï¼Œæ˜¯ä»¥æ•°ç»„æ–¹å¼çš„ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ª<code>action</code>åå­—å¯ä»¥å¯¹åº”å¤šä¸ª<code>action</code>çš„å‡½æ•°</p>
<p>è¿™é‡Œä¹Ÿå¯¹<code>action</code>è¿›è¡ŒåŒ…è£…ï¼Œä½¿å¾—å®ƒç»Ÿä¸€è¿”å›ä¸€ä¸ª<code>Promise</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">registerAction</span> (<span class="params">store, type, handler, local</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> entry = store.<span class="property">_actions</span>[type] || (store.<span class="property">_actions</span>[type] = [])</span><br><span class="line">  <span class="comment">// åŒ…è£…å‡½æ•°ï¼Œpushè¿›ç›¸åº”çš„åå­—ä¸­</span></span><br><span class="line">  entry.<span class="title function_">push</span>(<span class="keyword">function</span> <span class="title function_">wrappedActionHandler</span> (<span class="params">payload</span>) &#123;</span><br><span class="line">    <span class="comment">// è¿™é‡Œæ‰§è¡Œaction</span></span><br><span class="line">    <span class="keyword">let</span> res = handler.<span class="title function_">call</span>(store, &#123;</span><br><span class="line">      <span class="attr">dispatch</span>: local.<span class="property">dispatch</span>,</span><br><span class="line">      <span class="attr">commit</span>: local.<span class="property">commit</span>,</span><br><span class="line">      <span class="attr">getters</span>: local.<span class="property">getters</span>,</span><br><span class="line">      <span class="attr">state</span>: local.<span class="property">state</span>,</span><br><span class="line">      <span class="attr">rootGetters</span>: store.<span class="property">getters</span>,</span><br><span class="line">      <span class="attr">rootState</span>: store.<span class="property">state</span></span><br><span class="line">    &#125;, payload)</span><br><span class="line">    <span class="comment">// è¿™é‡ŒæŠŠç»“æœç»Ÿä¸€åŒ…è£…ä¸ºä¸€ä¸ªPromise</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isPromise</span>(res)) &#123;</span><br><span class="line">      res = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(res)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¼€å‘å·¥å…·çš„ä»£ç ï¼Œä¸ç®¡</span></span><br><span class="line">    <span class="keyword">if</span> (store.<span class="property">_devtoolHook</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">        store.<span class="property">_devtoolHook</span>.<span class="title function_">emit</span>(<span class="string">&#x27;vuex:error&#x27;</span>, err)</span><br><span class="line">        <span class="keyword">throw</span> err</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// è¿”å›è¿™ä¸ªPromise</span></span><br><span class="line">      <span class="keyword">return</span> res</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="getNestedState"><a href="#getNestedState" class="headerlink" title="getNestedState"></a><code>getNestedState</code></h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getNestedState</span> (<span class="params">state, path</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> path.<span class="title function_">reduce</span>(<span class="function">(<span class="params">state, key</span>) =&gt;</span> state[key], state)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¼ å…¥ä¸€ä¸ª<code>state</code>å’Œ<code>path</code>æ•°ç»„ï¼Œå–å¾—å¯¹åº”è·¯å¾„çš„çŠ¶æ€ï¼Œæ¯”å¦‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> state = &#123;</span><br><span class="line">  <span class="attr">a</span>: &#123;</span><br><span class="line">    <span class="attr">b</span>: &#123;</span><br><span class="line">      <span class="attr">c</span>: &#123;</span><br><span class="line">        <span class="attr">msg</span>: <span class="string">&#x27;Hello Vuex&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> nestedState = <span class="title function_">getNestedState</span>(state,[<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>]);</span><br></pre></td></tr></table></figure>

<p>è¿™æ—¶å€™<code>nestedState</code>å°±æ˜¯<code>&#123; msg: &quot;Hello Vuex&quot; &#125;</code></p>
<p>æ•°ç»„çš„<code>reduce</code>APIæ¯æ¬¡è¿”å›äº†ä¸‹ä¸€ä¸ªåå­—ä¸º<code>key</code>çŠ¶æ€<code>state[key]</code>ï¼Œä¸è¿‡ç”±äºæ²¡æœ‰åšåˆ¤æ–­ï¼Œå¦‚æœä¸­é—´å‡ºç°äº†ä¸å­˜åœ¨çš„çŠ¶æ€é‚£ä¹ˆä¼šæŠ¥é”™</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸æŠ¥é”™ï¼Œdå…¶å®ä¸å­˜åœ¨ï¼Œä½†æ˜¯ç”±äºæ˜¯æ•°ç»„çš„æœ€åä¸€é¡¹ï¼Œä¸ä¼šå†å»è®¿é—®ä¸‹ä¸€ä¸ªçŠ¶æ€</span></span><br><span class="line"><span class="title function_">getNestedState</span>(state, [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;d&#x27;</span>]);    <span class="comment">// è¿”å›undefined</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æŠ¥é”™ï¼Œdä¸å­˜åœ¨ï¼Œä¸æ˜¯æœ€åä¸€é¡¹ï¼Œæ¥ç€å‡ºç°äº†undefined[&#x27;e&#x27;]ï¼Œä»è€ŒæŠ¥é”™</span></span><br><span class="line"><span class="title function_">getNestedState</span>(state, [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;e&#x27;</span>]); </span><br></pre></td></tr></table></figure>

<h1 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h1><p>ç¬¬äºŒæ¬¡å†™è¿™ä¹ˆé•¿çš„æ–‡äº†ï¼Œå¯èƒ½æœ‰äº›åœ°æ–¹å†™çš„æ¯”è¾ƒæ™¦æ¶©ï¼Œå¦‚æœä½ æœ‰æ›´å¥½çš„å»ºè®®å¯ä»¥åœ¨ä¸‹é¢è¯„è®º</p>
<p>é™¤äº†<code>store.js</code>ï¼Œè¿˜æœ‰å‡ ä¸ªæ–‡ä»¶éœ€è¦ç¼–å†™ï¼Œä¸è¿‡éœ€è¦ä¸€ç‚¹æ—¶é—´</p>
<p><code>Vuex</code>å°å·§è€Œä¸”ç²¾è‡´ï¼Œå¾ˆå¤šæ—¶å€™æˆ‘ä¼šæƒŠå¹é‡Œé¢çš„å†™æ³•ï¼Œå¸Œæœ›æˆ‘ä»¥åä¹Ÿèƒ½å†™å‡ºè¿™ä¹ˆå¥½çš„ä»£ç </p>
<p>äººå•Šï¼Œæœ€é‡è¦çš„å°±æ˜¯å¼€å¿ƒ~</p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>æœ¬æ–‡ä½œè€…ï¼š </strong>Dedicatus545
  </li>
  <li class="post-copyright-link">
      <strong>æœ¬æ–‡é“¾æ¥ï¼š</strong>
      <a href="https://prohibitorum.top/085a4ad9e230" title="Vuex@nextæºç è§£æ - storeç¯‡">https://prohibitorum.top/085a4ad9e230</a>
  </li>
  <li class="post-copyright-license">
      <strong>ç‰ˆæƒå£°æ˜ï¼š </strong>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/JavaScript/" rel="tag"># JavaScript</a>
              <a href="/tags/Vue/" rel="tag"># Vue</a>
              <a href="/tags/Vuex/" rel="tag"># Vuex</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/4adeb697944c" rel="prev" title="JSå¦‚ä½•è§£æURLçš„å‚æ•°ï¼Ÿ">
                  <i class="fa fa-angle-left"></i> JSå¦‚ä½•è§£æURLçš„å‚æ•°ï¼Ÿ
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/8fc28eac39a3" rel="next" title="Vuex@nextæºç è§£æ - module-collectionç¯‡">
                  Vuex@nextæºç è§£æ - module-collectionç¯‡ <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Dedicatus545</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>ç«™ç‚¹æ€»å­—æ•°ï¼š</span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">425k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>ç«™ç‚¹é˜…è¯»æ—¶é•¿ &asymp;</span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">25:45</span>
  </span>
</div>

<div class="site_sign">
  <span class="post-meta-item">
    <span>
      å¦‚æœæˆ‘å’Œç‹—ä¸€æ ·æœ‰å°¾å·´çš„è¯ï¼Œä¸€å®šä¼šè—ä¸ä½è¿™ä»½å–œæ‚¦ï¼Œè€Œå°¾å·´ä¸€ç›´æ‘‡ä¸ªä¸åœå§ã€‚
    </span>
  </span>
</div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="è¿”å›é¡¶éƒ¨">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://fastly.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://fastly.jsdelivr.net/npm/@fancyapps/ui@5.0.31/dist/fancybox/fancybox.umd.js" integrity="sha256-a+H7FYzJv6oU2hfsfDGM2Ohw/cR9v+hPfxHCLdmCrE8=" crossorigin="anonymous"></script>
  <script src="https://fastly.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://fastly.jsdelivr.net/npm/algoliasearch@4.23.3/dist/algoliasearch-lite.umd.js" integrity="sha256-1QNshz86RqXe/qsCBldsUu13eAX6n/O98uubKQs87UI=" crossorigin="anonymous"></script>
<script src="https://fastly.jsdelivr.net/npm/instantsearch.js@4.67.0/dist/instantsearch.production.min.js" integrity="sha256-TW7D3X/i/W+RUgEeDppEnFT2ixv5lzplKH0c58D92dY=" crossorigin="anonymous"></script><script src="/js/third-party/search/algolia-search.js"></script>




  <script src="/js/third-party/fancybox.js"></script>



  




<link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/gitalk@1.8.0/dist/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"Dedicatus546","repo":"gitalk","client_id":"f7dc1ebbf18fc0fd3a5c","client_secret":"0893318788a1b62f883bdace8c12e6c42d76b402","admin_user":"Dedicatus546","distraction_free_mode":true,"proxy":"https://strong-caramel-969805.netlify.app/github_access_token","language":"zh-CN","js":{"url":"https://fastly.jsdelivr.net/npm/gitalk@1.8.0/dist/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"1603267330"}</script>
<script src="/js/third-party/comments/gitalk.js"></script>

<!-- hexo injector body_end start -->
<script src="https://cdn.jsdelivr.net/npm/swiper@11.1.9/swiper-bundle.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11.1.9/swiper-bundle.min.css">
<style>
    :root {
      --swiper-theme-color: var(--theme-color);
      --swiper-pagination-bottom: 0;
    }
    .swiper {
      padding-bottom: 32px;
      margin-bottom: 20px;
    }
    .swiper .swiper-slide .swiper-slide-img {
      display: block;
      width: 100%;
      object-fit: contain;
      background: var(--body-bg-color);
      margin: 0;
    }
  </style><!-- hexo injector body_end end --></body>
</html>
